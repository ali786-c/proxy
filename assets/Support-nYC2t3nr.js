import{j as e,x as g}from"./ui-DC8iaVTx.js";import{r as x,ae as M}from"./vendor-4c0ygcws.js";import{S as Y}from"./SEOHead-DpW2iBFV.js";import{C as k,a as K,b as $,c as _}from"./card-Dh3ArVV7.js";import{j as G,k as J,L as W,B as y,e as I,f as L,g as R,h as A,i as r,I as X,t as c,o as v,s as i,_ as Z,Q as S,x as O,v as ee}from"./index-BPJWA3ih.js";import{T as se}from"./textarea-CQC14rsn.js";import{T as te,a as ae,b as f,c as d,d as re,e as n}from"./table-CkxPTGa1.js";import{y as ie}from"./use-backend-BBvgsk5G.js";import"./useMutation-Ds_v8yer.js";const le=v({id:S(),message:i(),is_admin_reply:Z(),created_at:i()}),ne=v({id:S(),user_id:S(),subject:i(),status:i(),priority:i(),created_at:i(),updated_at:i(),user:v({email:i()}).nullable(),messages:O(le).optional()}),ce={open:"secondary",in_progress:"default",resolved:"outline",closed:"outline"},D={low:"secondary",medium:"default",high:"destructive"};function ye(){G();const[m,E]=x.useState(""),[p,F]=x.useState("all"),[l,h]=x.useState(null),[u,N]=x.useState(""),{data:o=[],isLoading:P}=J({queryKey:["admin","tickets"],queryFn:async()=>(await ee.get("/admin/support/tickets",O(ne))).map(t=>{var w,C;return{id:String(t.id),user:((w=t.user)==null?void 0:w.email)||"Unknown",subject:t.subject,category:"Support",status:t.status,priority:t.priority==="normal"?"medium":t.priority,created_at:t.created_at,updated_at:t.updated_at,messages:((C=t.messages)==null?void 0:C.map(j=>({sender:j.is_admin_reply?"support":"client",text:j.message,time:j.created_at})))||[]}})}),{replyTicket:U,updateStatus:B,deleteTicket:T}=ie(),a=o.find(s=>s.id===l)||null,H=async()=>{if(!(!u.trim()||!l))try{await U.mutateAsync({id:l,message:u}),N(""),c({title:"Reply Sent"})}catch(s){c({title:"Error",description:s.message,variant:"destructive"})}},q=async s=>{if(l)try{await B.mutateAsync({id:l,status:s}),c({title:"Status Updated"})}catch(t){c({title:"Error",description:t.message,variant:"destructive"})}},Q=async()=>{if(!(!l||!window.confirm("Are you sure you want to delete this ticket?")))try{await T.mutateAsync(l),h(null),c({title:"Ticket Deleted"})}catch(s){c({title:"Error",description:s.message,variant:"destructive"})}},b=o.filter(s=>{if(p!=="all"&&s.status!==p)return!1;if(m){const t=m.toLowerCase();return s.id.toLowerCase().includes(t)||s.user.toLowerCase().includes(t)||s.subject.toLowerCase().includes(t)}return!0}),V=o.filter(s=>s.status==="open").length,z=o.filter(s=>s.status==="in_progress").length;return P?e.jsx(W,{}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{title:"Admin — Support",noindex:!0}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Support Tickets"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[V," open · ",z," in progress · ",o.length," total"]})]})}),a?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(g,{variant:"outline",size:"sm",onClick:()=>h(null),children:"← Back"}),e.jsx(g,{variant:"destructive",size:"sm",onClick:Q,disabled:T.isPending,children:"Delete Ticket"})]}),e.jsxs(k,{children:[e.jsx(K,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx($,{className:"text-lg",children:a.subject}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["ID: ",a.id," · From: ",a.user]})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(y,{variant:D[a.priority],children:a.priority}),e.jsxs(I,{value:a.status,onValueChange:s=>q(s),children:[e.jsx(L,{className:"w-[140px] h-8 text-xs",children:e.jsx(R,{})}),e.jsxs(A,{children:[e.jsx(r,{value:"open",children:"Open"}),e.jsx(r,{value:"in_progress",children:"In Progress"}),e.jsx(r,{value:"resolved",children:"Resolved"}),e.jsx(r,{value:"closed",children:"Closed"})]})]})]})]})}),e.jsxs(_,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:a.messages.map((s,t)=>e.jsxs("div",{className:`rounded-lg p-3 text-sm ${s.sender==="support"?"bg-primary/5 ml-8":"bg-muted mr-8"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"font-medium text-xs",children:s.sender==="support"?"Support (You)":a.user}),e.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(s.time).toLocaleString()})]}),e.jsx("p",{children:s.text})]},t))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(se,{value:u,onChange:s=>N(s.target.value),placeholder:"Type your reply...",rows:2,className:"flex-1"}),e.jsx(g,{onClick:H,disabled:!u.trim(),className:"self-end",children:"Send"})]})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"relative flex-1 min-w-[200px]",children:[e.jsx(M,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(X,{placeholder:"Search tickets...",value:m,onChange:s=>E(s.target.value),className:"pl-9"})]}),e.jsxs(I,{value:p,onValueChange:F,children:[e.jsx(L,{className:"w-[150px]",children:e.jsx(R,{placeholder:"Status"})}),e.jsxs(A,{children:[e.jsx(r,{value:"all",children:"All"}),e.jsx(r,{value:"open",children:"Open"}),e.jsx(r,{value:"in_progress",children:"In Progress"}),e.jsx(r,{value:"resolved",children:"Resolved"}),e.jsx(r,{value:"closed",children:"Closed"})]})]})]}),e.jsx(k,{children:e.jsx(_,{className:"p-0",children:e.jsxs(te,{children:[e.jsx(ae,{children:e.jsxs(f,{children:[e.jsx(d,{children:"ID"}),e.jsx(d,{children:"User"}),e.jsx(d,{children:"Subject"}),e.jsx(d,{children:"Priority"}),e.jsx(d,{children:"Status"}),e.jsx(d,{className:"text-right",children:"Updated"})]})}),e.jsxs(re,{children:[b.map(s=>e.jsxs(f,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>h(s.id),children:[e.jsx(n,{className:"font-mono text-xs",children:s.id}),e.jsx(n,{className:"text-sm",children:s.user}),e.jsx(n,{className:"font-medium",children:s.subject}),e.jsx(n,{children:e.jsx(y,{variant:D[s.priority],className:"text-xs",children:s.priority})}),e.jsx(n,{children:e.jsx(y,{variant:ce[s.status],className:"text-xs",children:s.status.replace("_"," ")})}),e.jsx(n,{className:"text-right text-xs text-muted-foreground",children:new Date(s.updated_at).toLocaleDateString()})]},s.id)),b.length===0&&e.jsx(f,{children:e.jsx(n,{colSpan:6,className:"h-24 text-center text-muted-foreground",children:"No tickets match."})})]})]})})})]})]})]})}export{ye as default};
