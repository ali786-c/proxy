import{j as e,x as d}from"./ui-CeaNA1b8.js";import{r as l,t as re,H as Ne,aA as z,aE as Ce,a3 as le,aw as Y,ay as Se,a5 as Ae,d as ce,aF as Te,D as Pe}from"./vendor-CSZBJNtL.js";import{S as Me}from"./SEOHead-CV9z8O-_.js";import{C as F,a as _,b as E,d as oe,c as B}from"./card-clxFFivi.js";import{T as ke,a as Fe,b as de,c as $,d as _e,e as q}from"./table-D3uMK-0w.js";import{j as Ee,l as Be,b as $e,u as qe,d as De,k as O,c,I as g,B as v,m as Le}from"./index-D230i8hy.js";import{L as b}from"./label-5YbheAOU.js";import{S as Ve}from"./switch-Dcpl_lpr.js";import{u as Ie}from"./useMutation-1EhplJK_.js";import{M as Ke}from"./ManualCryptoDialog-D8ztdDio.js";const Qe=.22,f=5,Re={paid:"default",pending:"secondary",failed:"destructive"};function ts(){const p=Ee(),{toast:i}=Be(),{format:u,currency:D}=$e(),{t:x}=qe(),[ue]=l.useState("residential"),[w,G]=l.useState("50"),{gateways:j,autoTopUpEnabled:me}=De(),[L,V]=l.useState(!1),[N,W]=l.useState("50"),[I,J]=l.useState("5"),[K,X]=l.useState("500"),[o,pe]=l.useState(null),[C,Z]=l.useState(""),[S,h]=l.useState(!1),[he,ee]=l.useState(!1),[n,Q]=l.useState(null),[se,te]=l.useState(!1),{data:t,isLoading:Ue}=O({queryKey:["top-up-settings"],queryFn:()=>c.getTopUpSettings()}),[He,R]=l.useState(!1);l.useEffect(()=>{const s=new URLSearchParams(window.location.search);if(s.get("success")==="true"){const a=s.get("session_id");window.history.replaceState({},document.title,window.location.pathname),a?c.verifySession(a).then(()=>{p.invalidateQueries({queryKey:["me"]}),p.invalidateQueries({queryKey:["invoices"]}),p.invalidateQueries({queryKey:["stats"]}),R(!0)}).catch(()=>{p.invalidateQueries({queryKey:["me"]}),p.invalidateQueries({queryKey:["invoices"]}),R(!0)}):(p.invalidateQueries({queryKey:["me"]}),p.invalidateQueries({queryKey:["invoices"]}),R(!0))}else s.get("setup_success")==="true"?(i({title:"Card Saved",description:"Your payment method has been securely saved for auto top-up."}),window.history.replaceState({},document.title,window.location.pathname)):s.get("setup_canceled")==="true"?(i({title:"Setup Canceled",description:"Card setup was canceled. Auto top-up remains disabled.",variant:"destructive"}),window.history.replaceState({},document.title,window.location.pathname)):s.get("canceled")==="true"&&(i({title:"Payment Canceled",description:"Your payment was canceled. No charges were made.",variant:"destructive"}),window.history.replaceState({},document.title,window.location.pathname))},[]),l.useMemo(()=>{t&&(V(t.enabled),W(t.amount.toString()),J(t.threshold.toString()),X(t.max_monthly.toString()))},[t]);const A=Ie({mutationFn:s=>c.updateTopUpSettings(s),onSuccess:()=>{p.invalidateQueries({queryKey:["top-up-settings"]}),i({title:"Settings Saved",description:"Your auto top-up preferences have been updated."})},onError:s=>i({title:"Error",description:s.message,variant:"destructive"})}),{data:xe}=O({queryKey:["plans"],queryFn:()=>c.getPlans()}),{data:ye}=O({queryKey:["invoices"],queryFn:()=>c.getInvoices()}),y=parseFloat(w)||0,U=n?n.discount:0,T=Math.max(0,y-U),P=o==="cryptomus"||o==="manual",ae=P?0:T*Qe,M=T+ae,ie=s=>D.exchange_rate*s,m=D.symbol,k=ie(f),H=y<k,je=async()=>{if(C.trim()){if(y<f){i({title:"Error",description:`Please enter an amount of at least ${u(f)} first.`,variant:"destructive"});return}te(!0);try{const s=await c.validateCoupon(C.toUpperCase(),y);s.valid&&(Q({code:s.code,discount:s.discount,type:s.type,value:s.value}),i({title:"Coupon Applied",description:`You saved ${u(s.discount)}!`}))}catch(s){Q(null),i({title:"Invalid Coupon",description:s.message||"This code is not valid.",variant:"destructive"})}finally{te(!1)}}},fe=s=>{i({title:"Product Selected",description:`Switching to ${s}.`})},ge=async s=>{if(V(s),s&&t&&!t.has_payment_method)try{const{url:a}=await c.createSetupIntent();window.location.href=a}catch(a){i({title:"Setup Error",description:a.message,variant:"destructive"}),V(!1)}else A.mutate({enabled:s,threshold:parseFloat(I),amount:parseFloat(N),max_monthly:parseFloat(K)})},ve=()=>{A.mutate({enabled:L,threshold:parseFloat(I),amount:parseFloat(N),max_monthly:parseFloat(K)})},be=async()=>{if(H){i({title:"Minimum not met",description:`Minimum purchase is ${m}${k.toFixed(2)}.`,variant:"destructive"});return}if(!o){i({title:"Select a payment method",description:"Please choose how you'd like to pay.",variant:"destructive"});return}if(o==="cryptomus"){h(!0);try{const{url:s}=await c.createCryptomusCheckout(y,n==null?void 0:n.code);window.location.href=s}catch(s){i({title:"Checkout Error",description:s.message,variant:"destructive"})}finally{h(!1)}}else if(o==="stripe"){h(!0);try{const{url:s}=await c.createCheckout(M,T,D.code);window.location.href=s}catch(s){i({title:"Checkout Error",description:s.message,variant:"destructive"})}finally{h(!1)}}else o==="manual"?ee(!0):i({title:`Pay with ${o}`,description:`Redirecting to ${o} checkout for ${u(M)}...`})},ne=[{id:"stripe",name:"Card (Stripe)",subtitle:"Credit/Debit Card",icon:re,vatLabel:"+22% VAT",enabled:j.stripe},{id:"paypal",name:"PayPal",subtitle:"PayPal Balance",icon:Ne,vatLabel:"+22% VAT",enabled:j.paypal},{id:"cryptomus",name:"Crypto",subtitle:"Automated via Cryptomus",icon:z,vatLabel:"No VAT",enabled:j.cryptomus},{id:"manual",name:"Binance Pay",subtitle:"Manual Transfer",icon:z,vatLabel:"No VAT",enabled:j.crypto}],we=ne.length>0;return e.jsxs(e.Fragment,{children:[e.jsx(Me,{title:"Account & Billing",noindex:!0}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Account & Billing"}),e.jsxs(F,{children:[e.jsxs(_,{children:[e.jsxs(E,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Ce,{className:"h-5 w-5"})," ",x("billing.topUp")]}),e.jsxs(oe,{children:[x("billing.minPurchaseTitle"),": ",u(f),". 22% VAT applies to card & PayPal payments. Crypto is VAT-free."]})]}),e.jsxs(B,{className:"space-y-5",children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2 max-w-lg",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(b,{children:"Amount"}),e.jsx(g,{type:"number",value:w,onChange:s=>G(s.target.value),min:k,step:"0.01",placeholder:`Min ${m}${k.toFixed(2)}`}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:[10,25,50,100].map(s=>{const a=ie(s),r=a.toFixed(2);return e.jsxs(d,{variant:"outline",size:"sm",className:`text-xs h-7 px-3 ${parseFloat(w)===a?"border-primary bg-primary/5 text-primary":""}`,onClick:()=>G(r),children:[m,r]},s)})}),H&&y>0&&e.jsxs("p",{className:"text-xs text-destructive flex items-center gap-1",children:[e.jsx(le,{className:"h-3 w-3"})," Minimum purchase is ",u(f)]})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(b,{children:"Promo Code (optional)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{placeholder:"WELCOME20",value:C,onChange:s=>Z(s.target.value),className:n?"border-green-500 bg-green-500/5":"",disabled:!!n}),n?e.jsx(d,{variant:"outline",size:"sm",onClick:()=>{Q(null),Z("")},children:"Remove"}):e.jsx(d,{variant:"outline",size:"sm",className:"shrink-0",onClick:je,disabled:se||!C.trim(),children:se?e.jsx(Y,{className:"h-4 w-4 animate-spin"}):"Apply"})]}),n&&e.jsxs("p",{className:"text-[11px] text-green-600 font-medium",children:[" Coupon applied: ",n.type==="percentage"?`${n.value}%`:`${u(n.value)}`," off"]})]})]}),!we&&e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"No payment methods are currently available. Please contact support."}),e.jsx("div",{className:"grid gap-3 sm:grid-cols-3",children:ne.map(s=>{const a=s.enabled,r=o===s.id;return e.jsxs(d,{variant:r?"default":"outline",className:`h-auto py-4 flex-col gap-1 relative ${a?"":"opacity-40 cursor-not-allowed"}`,disabled:!a,onClick:()=>pe(s.id),children:[e.jsx(s.icon,{className:"h-6 w-6"}),e.jsx("span",{className:"font-semibold",children:s.name}),e.jsx("span",{className:"text-[11px] font-normal opacity-80",children:s.subtitle}),e.jsx(v,{variant:s.id==="crypto"||s.id==="manual"?"default":"secondary",className:"text-[10px] mt-1",children:s.vatLabel}),!a&&e.jsx("span",{className:"text-[10px] font-normal",children:"Not available"})]},s.id)})}),o&&y>=f&&e.jsxs("div",{className:"rounded-lg border bg-muted/30 p-4 max-w-sm space-y-2",children:[e.jsx("h4",{className:"text-sm font-semibold",children:x("billing.orderSummary")}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:x("billing.subtotal")}),e.jsxs("span",{children:[m,T.toFixed(2)]})]}),U>0&&e.jsxs("div",{className:"flex justify-between text-sm text-green-600 font-medium font-mono",children:[e.jsxs("span",{children:["Discount (",n==null?void 0:n.code,")"]}),e.jsxs("span",{children:["-",m,U.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"flex items-center gap-1",children:["VAT (22%)",P&&e.jsx(Se,{className:"h-3 w-3 text-muted-foreground"})]}),e.jsx("span",{className:P?"line-through text-muted-foreground":"",children:P?`${m}0.00 â€” exempt`:`${m}${ae.toFixed(2)}`})]}),e.jsx(Le,{}),e.jsxs("div",{className:"flex justify-between text-sm font-bold",children:[e.jsx("span",{children:x("common.total")}),e.jsxs("span",{children:[m,M.toFixed(2)]})]}),e.jsxs(d,{className:"w-full mt-2",onClick:be,disabled:H||S,children:[S?e.jsx(Y,{className:"mr-2 h-4 w-4 animate-spin"}):null,x("common.pay")," ",m,M.toFixed(2)]})]})]})]}),me&&e.jsxs(F,{className:t!=null&&t.global_enabled?"":"opacity-60 grayscale-[0.5]",children:[e.jsxs(_,{children:[e.jsxs(E,{className:"flex items-center justify-between text-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ae,{className:"h-5 w-5"})," Auto Top-Up"]}),t!=null&&t.has_payment_method?e.jsxs(v,{variant:"secondary",className:"bg-green-100 text-green-700 hover:bg-green-100 flex gap-1 items-center",children:[e.jsx(ce,{className:"h-3 w-3"})," Card Saved"]}):e.jsxs(v,{variant:"outline",className:"text-muted-foreground flex gap-1 items-center",children:[e.jsx(le,{className:"h-3 w-3"})," No Card Saved"]})]}),!(t!=null&&t.global_enabled)&&e.jsx(oe,{className:"text-destructive font-medium",children:"Auto Top-up is currently disabled by the administrator."})]}),e.jsxs(B,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Enable Auto Top-Up"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Automatically add balance when it drops below the threshold"})]}),e.jsx(Ve,{checked:L,onCheckedChange:ge,disabled:!(t!=null&&t.global_enabled)})]}),L&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-3",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(b,{children:"Min Balance Threshold"}),e.jsx(g,{type:"number",value:I,onChange:s=>J(s.target.value)})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(b,{children:"Top-Up Amount"}),e.jsx(g,{type:"number",value:N,onChange:s=>W(s.target.value)})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(b,{children:"Monthly Max Cap"}),e.jsx(g,{type:"number",value:K,onChange:s=>X(s.target.value)})]})]}),e.jsxs("div",{className:"flex justify-between items-center pt-2",children:[e.jsxs("p",{className:"text-[11px] text-muted-foreground max-w-[250px]",children:["A 22% Stripe VAT will be added to each auto top-up. Total charge: ",u(parseFloat(N)*1.22)]}),e.jsxs(d,{size:"sm",onClick:ve,disabled:A.isPending,children:[A.isPending?e.jsx(Y,{className:"h-3 w-3 animate-spin mr-1"}):e.jsx(Te,{className:"h-3 w-3 mr-1"}),"Save Preferences"]})]})]})]})]}),e.jsx("div",{className:"grid gap-4 sm:grid-cols-3",children:(xe||[]).map(s=>{const a=s.id===ue;return e.jsxs(F,{className:a?"border-primary ring-2 ring-primary/20":"",children:[e.jsx(_,{className:"pb-2",children:e.jsxs(E,{className:"flex items-center justify-between text-lg",children:[s.name,a&&e.jsx(v,{children:"Active"})]})}),e.jsxs(B,{className:"space-y-4",children:[e.jsxs("p",{className:"text-3xl font-bold",children:[u(s.price_cents/100),e.jsxs("span",{className:"text-base font-normal text-muted-foreground",children:["/",(s.id==="datacenter","GB")]})]}),e.jsx("ul",{className:"space-y-1.5",children:s.features.map(r=>e.jsxs("li",{className:"flex items-start gap-2 text-sm text-muted-foreground",children:[e.jsx(ce,{className:"mt-0.5 h-4 w-4 shrink-0 text-primary"}),r]},r))}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{variant:a?"outline":"default",className:"w-full",disabled:a,onClick:()=>fe(s.id),children:a?"Active Product":"Select Product"}),!a&&e.jsxs("div",{className:"flex flex-col gap-2",children:[j.stripe&&e.jsxs(d,{variant:"secondary",className:"w-full gap-2",disabled:S,onClick:async()=>{h(!0);try{const{url:r}=await c.createProductCheckout(s.id,1);window.location.href=r}catch(r){i({title:"Purchase Error",description:r.message,variant:"destructive"})}finally{h(!1)}},children:[e.jsx(re,{className:"h-4 w-4"})," Buy with Card"]}),j.cryptomus&&e.jsxs(d,{variant:"outline",className:"w-full gap-2 border-primary/20 hover:border-primary/50",disabled:S,onClick:async()=>{h(!0);try{const{url:r}=await c.createCryptomusProductCheckout(s.id,1);window.location.href=r}catch(r){i({title:"Purchase Error",description:r.message,variant:"destructive"})}finally{h(!1)}},children:[e.jsx(z,{className:"h-4 w-4 text-orange-500"})," Buy with Crypto"]})]})]})]})]},s.id)})}),e.jsxs(F,{children:[e.jsx(_,{children:e.jsx(E,{className:"text-lg",children:x("nav.invoices")})}),e.jsx(B,{className:"p-0",children:e.jsxs(ke,{children:[e.jsx(Fe,{children:e.jsxs(de,{children:[e.jsx($,{children:"Period"}),e.jsx($,{children:"Amount"}),e.jsx($,{children:"Status"}),e.jsx($,{className:"text-right",children:"Date"})]})}),e.jsx(_e,{children:(ye||[]).map(s=>e.jsxs(de,{children:[e.jsx(q,{className:"font-medium",children:s.period}),e.jsx(q,{children:u(s.amount_cents/100)}),e.jsx(q,{children:e.jsx(v,{variant:Re[s.status]??"secondary",children:s.status})}),e.jsxs(q,{className:"text-right text-sm text-muted-foreground space-x-2",children:[e.jsx("span",{children:new Date(s.created_at).toLocaleDateString()}),s.pdf_url&&e.jsx(d,{variant:"ghost",size:"icon",className:"h-7 w-7",asChild:!0,title:"Download PDF",children:e.jsx("a",{href:s.pdf_url,target:"_blank",rel:"noopener noreferrer",children:e.jsx(Pe,{className:"h-3.5 w-3.5"})})})]})]},s.id))})]})})]})]}),e.jsx(Ke,{open:he,onOpenChange:ee,defaultAmount:w})]})}export{ts as default};
