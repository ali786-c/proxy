import{Q as $,r as u,U as z,j as e,a as k,x as _,y as w,z as I,E as R,J as r,I as Y,t as L,ae as h,af as O,o as y,s as l,aP as J,aj as f,ah as B}from"./index-C-hQHNw1.js";import{S as G}from"./SEOHead-YzVvxQ4K.js";import{C as F,a as W,b as X,c as q}from"./card-RM_oJbVE.js";import{B as j}from"./badge-LB6dqpLf.js";import{T as Z}from"./textarea-BdZb5zDL.js";import{T as ee,a as se,b as g,c as n,d as te,e as i}from"./table-ehW73X9l.js";import{u as P}from"./useMutation-DR2AoCow.js";import{S as ae}from"./search-IEN1uYtn.js";const re=y({id:f(),message:l(),is_admin_reply:J(),created_at:l()}),le=y({id:f(),user_id:f(),subject:l(),status:l(),priority:l(),created_at:l(),updated_at:l(),user:y({email:l()}).nullable(),messages:B(re).optional()}),ie={open:"secondary",in_progress:"default",resolved:"outline",closed:"outline"},U={low:"secondary",medium:"default",high:"destructive"};function je(){const v=$(),[x,M]=u.useState(""),[m,Q]=u.useState("all"),[d,S]=u.useState(null),[o,N]=u.useState(""),{data:c=[],isLoading:ne}=z({queryKey:["admin-tickets"],queryFn:async()=>(await h.get("/admin/support/tickets",B(le))).map(t=>{var T,C;return{id:String(t.id),user:((T=t.user)==null?void 0:T.email)||"Unknown",subject:t.subject,category:"technical",status:t.status,priority:t.priority==="normal"?"medium":t.priority,created_at:t.created_at,updated_at:t.updated_at,messages:((C=t.messages)==null?void 0:C.map(p=>({sender:p.is_admin_reply?"support":"client",text:p.message,time:p.created_at})))||[]}})}),A=P({mutationFn:s=>h.post(`/admin/support/tickets/${d}/reply`,O,{message:s}),onSuccess:()=>{v.invalidateQueries({queryKey:["admin-tickets"]}),N(""),L({title:"Reply Sent"})}}),D=P({mutationFn:s=>h.post(`/admin/support/tickets/${d}/status`,O,{status:s}),onSuccess:()=>{v.invalidateQueries({queryKey:["admin-tickets"]}),L({title:"Status Updated"})}}),a=c.find(s=>s.id===d)||null,E=()=>{!o.trim()||!d||A.mutate(o)},H=(s,t)=>{D.mutate(t)},b=c.filter(s=>{if(m!=="all"&&s.status!==m)return!1;if(x){const t=x.toLowerCase();return s.id.toLowerCase().includes(t)||s.user.toLowerCase().includes(t)||s.subject.toLowerCase().includes(t)}return!0}),K=c.filter(s=>s.status==="open").length,V=c.filter(s=>s.status==="in_progress").length;return e.jsxs(e.Fragment,{children:[e.jsx(G,{title:"Admin — Support",noindex:!0}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Support Tickets"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[K," open · ",V," in progress · ",c.length," total"]})]})}),a?e.jsxs("div",{className:"space-y-4",children:[e.jsx(k,{variant:"outline",size:"sm",onClick:()=>S(null),children:"← Back"}),e.jsxs(F,{children:[e.jsx(W,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(X,{className:"text-lg",children:a.subject}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[a.id," · ",a.user," · ",a.category]})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(j,{variant:U[a.priority],children:a.priority}),e.jsxs(_,{value:a.status,onValueChange:s=>H(a.id,s),children:[e.jsx(w,{className:"w-[140px] h-8 text-xs",children:e.jsx(I,{})}),e.jsxs(R,{children:[e.jsx(r,{value:"open",children:"Open"}),e.jsx(r,{value:"in_progress",children:"In Progress"}),e.jsx(r,{value:"resolved",children:"Resolved"}),e.jsx(r,{value:"closed",children:"Closed"})]})]})]})]})}),e.jsxs(q,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:a.messages.map((s,t)=>e.jsxs("div",{className:`rounded-lg p-3 text-sm ${s.sender==="support"?"bg-primary/5 ml-8":"bg-muted mr-8"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"font-medium text-xs",children:s.sender==="support"?"Support (You)":a.user}),e.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(s.time).toLocaleString()})]}),e.jsx("p",{children:s.text})]},t))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Z,{value:o,onChange:s=>N(s.target.value),placeholder:"Type your reply...",rows:2,className:"flex-1"}),e.jsx(k,{onClick:E,disabled:!o.trim(),className:"self-end",children:"Send"})]})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"relative flex-1 min-w-[200px]",children:[e.jsx(ae,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(Y,{placeholder:"Search tickets...",value:x,onChange:s=>M(s.target.value),className:"pl-9"})]}),e.jsxs(_,{value:m,onValueChange:Q,children:[e.jsx(w,{className:"w-[150px]",children:e.jsx(I,{placeholder:"Status"})}),e.jsxs(R,{children:[e.jsx(r,{value:"all",children:"All"}),e.jsx(r,{value:"open",children:"Open"}),e.jsx(r,{value:"in_progress",children:"In Progress"}),e.jsx(r,{value:"resolved",children:"Resolved"}),e.jsx(r,{value:"closed",children:"Closed"})]})]})]}),e.jsx(F,{children:e.jsx(q,{className:"p-0",children:e.jsxs(ee,{children:[e.jsx(se,{children:e.jsxs(g,{children:[e.jsx(n,{children:"ID"}),e.jsx(n,{children:"User"}),e.jsx(n,{children:"Subject"}),e.jsx(n,{children:"Priority"}),e.jsx(n,{children:"Status"}),e.jsx(n,{className:"text-right",children:"Updated"})]})}),e.jsxs(te,{children:[b.map(s=>e.jsxs(g,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>S(s.id),children:[e.jsx(i,{className:"font-mono text-xs",children:s.id}),e.jsx(i,{className:"text-sm",children:s.user}),e.jsx(i,{className:"font-medium",children:s.subject}),e.jsx(i,{children:e.jsx(j,{variant:U[s.priority],className:"text-xs",children:s.priority})}),e.jsx(i,{children:e.jsx(j,{variant:ie[s.status],className:"text-xs",children:s.status.replace("_"," ")})}),e.jsx(i,{className:"text-right text-xs text-muted-foreground",children:new Date(s.updated_at).toLocaleDateString()})]},s.id)),b.length===0&&e.jsx(g,{children:e.jsx(i,{colSpan:6,className:"h-24 text-center text-muted-foreground",children:"No tickets match."})})]})]})})})]})]})]})}export{je as default};
