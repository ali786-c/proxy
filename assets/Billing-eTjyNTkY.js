import{j as e,x as d}from"./ui-BkJV2AdO.js";import{r as l,t as se,H as fe,aA as R,aE as ge,a3 as te,aw as U,ay as ve,a5 as be,d as ae,aF as Ne,D as we}from"./vendor-BJanyxg7.js";import{S as Ce}from"./SEOHead-zUe1Kw_P.js";import{C as A,a as T,b as P,d as ne,c as M}from"./card-l-SRMqus.js";import{T as Se,a as Ae,b as re,c as k,d as Te,e as E}from"./table-8_4vQSbC.js";import{j as Pe,l as Me,b as ke,u as Ee,d as _e,k as q,I as y,B as f,m as Be,c as u}from"./index-BE2SVdoe.js";import{L as g}from"./label-BFQ1M4xB.js";import{S as Fe}from"./switch-D6bbwvTG.js";import{u as $e}from"./useMutation-CNPaL6NV.js";import{M as Le}from"./ManualCryptoDialog-BTrk_p1A.js";const De=.22,h=5,Ve={paid:"default",pending:"secondary",failed:"destructive"};function We(){const ie=Pe(),{toast:r}=Me(),{format:a}=ke(),{t:p}=Ee(),[H]=l.useState("residential"),[v,z]=l.useState("50"),{gateways:j,autoTopUpEnabled:le}=_e(),[_,B]=l.useState(!1),[b,K]=l.useState("50"),[F,O]=l.useState("5"),[$,Y]=l.useState("500"),[o,ce]=l.useState(null),[N,G]=l.useState(""),[w,x]=l.useState(!1),[oe,Q]=l.useState(!1),[n,L]=l.useState(null),[W,J]=l.useState(!1),{data:t,isLoading:Ie}=q({queryKey:["top-up-settings"],queryFn:()=>u.getTopUpSettings()});l.useEffect(()=>{const s=new URLSearchParams(window.location.search);s.get("setup_success")==="true"?(r({title:"Card Saved",description:"Your payment method has been securely saved for auto top-up."}),window.history.replaceState({},document.title,window.location.pathname)):s.get("setup_canceled")==="true"&&(r({title:"Setup Canceled",description:"Card setup was canceled. Auto top-up remains disabled.",variant:"destructive"}),window.history.replaceState({},document.title,window.location.pathname))},[]),l.useMemo(()=>{t&&(B(t.enabled),K(t.amount.toString()),O(t.threshold.toString()),Y(t.max_monthly.toString()))},[t]);const C=$e({mutationFn:s=>u.updateTopUpSettings(s),onSuccess:()=>{ie.invalidateQueries({queryKey:["top-up-settings"]}),r({title:"Settings Saved",description:"Your auto top-up preferences have been updated."})},onError:s=>r({title:"Error",description:s.message,variant:"destructive"})}),{data:de}=q({queryKey:["plans"],queryFn:()=>u.getPlans()}),{data:ue}=q({queryKey:["invoices"],queryFn:()=>u.getInvoices()}),m=parseFloat(v)||0,D=n?n.discount:0,X=Math.max(0,m-D),S=o==="cryptomus"||o==="manual",Z=S?0:X*De,V=X+Z,I=m<h,me=async()=>{if(N.trim()){if(m<h){r({title:"Error",description:`Please enter an amount of at least ${a(h)} first.`,variant:"destructive"});return}J(!0);try{const s=await u.validateCoupon(N.toUpperCase(),m);s.valid&&(L({code:s.code,discount:s.discount,type:s.type,value:s.value}),r({title:"Coupon Applied",description:`You saved ${a(s.discount)}!`}))}catch(s){L(null),r({title:"Invalid Coupon",description:s.message||"This code is not valid.",variant:"destructive"})}finally{J(!1)}}},he=s=>{r({title:"Product Selected",description:`Switching to ${s}.`})},xe=async s=>{if(B(s),s&&t&&!t.has_payment_method)try{const{url:i}=await u.createSetupIntent();window.location.href=i}catch(i){r({title:"Setup Error",description:i.message,variant:"destructive"}),B(!1)}else C.mutate({enabled:s,threshold:parseFloat(F),amount:parseFloat(b),max_monthly:parseFloat($)})},pe=()=>{C.mutate({enabled:_,threshold:parseFloat(F),amount:parseFloat(b),max_monthly:parseFloat($)})},je=async()=>{if(I){r({title:"Minimum not met",description:`Minimum purchase is ${a(h)}.`,variant:"destructive"});return}if(!o){r({title:"Select a payment method",description:"Please choose how you'd like to pay.",variant:"destructive"});return}if(o==="cryptomus"){x(!0);try{const{url:s}=await u.createCryptomusCheckout(m,n==null?void 0:n.code);window.location.href=s}catch(s){r({title:"Checkout Error",description:s.message,variant:"destructive"})}finally{x(!1)}}else if(o==="stripe"){x(!0);try{const{url:s}=await u.createCheckout(H,m,n==null?void 0:n.code);window.location.href=s}catch(s){r({title:"Checkout Error",description:s.message,variant:"destructive"})}finally{x(!1)}}else o==="manual"?Q(!0):r({title:`Pay with ${o}`,description:`Redirecting to ${o} checkout for ${a(V)}...`})},ee=[{id:"stripe",name:"Card (Stripe)",subtitle:"Credit/Debit Card",icon:se,vatLabel:"+22% VAT",enabled:j.stripe},{id:"paypal",name:"PayPal",subtitle:"PayPal Balance",icon:fe,vatLabel:"+22% VAT",enabled:j.paypal},{id:"cryptomus",name:"Crypto",subtitle:"Automated via Cryptomus",icon:R,vatLabel:"No VAT",enabled:j.cryptomus},{id:"manual",name:"Binance Pay",subtitle:"Manual Transfer",icon:R,vatLabel:"No VAT",enabled:j.crypto}],ye=ee.length>0;return e.jsxs(e.Fragment,{children:[e.jsx(Ce,{title:"Account & Billing",noindex:!0}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Account & Billing"}),e.jsxs(A,{children:[e.jsxs(T,{children:[e.jsxs(P,{className:"flex items-center gap-2 text-lg",children:[e.jsx(ge,{className:"h-5 w-5"})," ",p("billing.topUp")]}),e.jsxs(ne,{children:[p("billing.minPurchaseTitle"),": ",a(h),". 22% VAT applies to card & PayPal payments. Crypto is VAT-free."]})]}),e.jsxs(M,{className:"space-y-5",children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2 max-w-lg",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(g,{children:"Amount"}),e.jsx(y,{type:"number",value:v,onChange:s=>z(s.target.value),min:h,step:"1",placeholder:`Min ${a(h)}`}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:["10","25","50","100"].map(s=>e.jsx(d,{variant:"outline",size:"sm",className:`text-xs h-7 px-3 ${v===s?"border-primary bg-primary/5 text-primary":""}`,onClick:()=>z(s),children:a(Number(s))},s))}),I&&m>0&&e.jsxs("p",{className:"text-xs text-destructive flex items-center gap-1",children:[e.jsx(te,{className:"h-3 w-3"})," Minimum purchase is ",a(h)]})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(g,{children:"Promo Code (optional)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{placeholder:"WELCOME20",value:N,onChange:s=>G(s.target.value),className:n?"border-green-500 bg-green-500/5":"",disabled:!!n}),n?e.jsx(d,{variant:"outline",size:"sm",onClick:()=>{L(null),G("")},children:"Remove"}):e.jsx(d,{variant:"outline",size:"sm",className:"shrink-0",onClick:me,disabled:W||!N.trim(),children:W?e.jsx(U,{className:"h-4 w-4 animate-spin"}):"Apply"})]}),n&&e.jsxs("p",{className:"text-[11px] text-green-600 font-medium",children:[" Coupon applied: ",n.type==="percentage"?`${n.value}%`:`${a(n.value)}`," off"]})]})]}),!ye&&e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"No payment methods are currently available. Please contact support."}),e.jsx("div",{className:"grid gap-3 sm:grid-cols-3",children:ee.map(s=>{const i=s.enabled,c=o===s.id;return e.jsxs(d,{variant:c?"default":"outline",className:`h-auto py-4 flex-col gap-1 relative ${i?"":"opacity-40 cursor-not-allowed"}`,disabled:!i,onClick:()=>ce(s.id),children:[e.jsx(s.icon,{className:"h-6 w-6"}),e.jsx("span",{className:"font-semibold",children:s.name}),e.jsx("span",{className:"text-[11px] font-normal opacity-80",children:s.subtitle}),e.jsx(f,{variant:s.id==="crypto"||s.id==="manual"?"default":"secondary",className:"text-[10px] mt-1",children:s.vatLabel}),!i&&e.jsx("span",{className:"text-[10px] font-normal",children:"Not available"})]},s.id)})}),o&&m>=h&&e.jsxs("div",{className:"rounded-lg border bg-muted/30 p-4 max-w-sm space-y-2",children:[e.jsx("h4",{className:"text-sm font-semibold",children:p("billing.orderSummary")}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:p("billing.subtotal")}),e.jsx("span",{children:a(m)})]}),D>0&&e.jsxs("div",{className:"flex justify-between text-sm text-green-600 font-medium font-mono",children:[e.jsxs("span",{children:["Discount (",n==null?void 0:n.code,")"]}),e.jsxs("span",{children:["-",a(D)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"flex items-center gap-1",children:["VAT (22%)",S&&e.jsx(ve,{className:"h-3 w-3 text-muted-foreground"})]}),e.jsx("span",{className:S?"line-through text-muted-foreground":"",children:S?`${a(0)} â€” exempt`:`${a(Z)}`})]}),e.jsx(Be,{}),e.jsxs("div",{className:"flex justify-between text-sm font-bold",children:[e.jsx("span",{children:p("common.total")}),e.jsx("span",{children:a(V)})]}),e.jsxs(d,{className:"w-full mt-2",onClick:je,disabled:I||w,children:[w?e.jsx(U,{className:"mr-2 h-4 w-4 animate-spin"}):null,p("common.pay")," ",a(V)]})]})]})]}),le&&e.jsxs(A,{className:t!=null&&t.global_enabled?"":"opacity-60 grayscale-[0.5]",children:[e.jsxs(T,{children:[e.jsxs(P,{className:"flex items-center justify-between text-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-5 w-5"})," Auto Top-Up"]}),t!=null&&t.has_payment_method?e.jsxs(f,{variant:"secondary",className:"bg-green-100 text-green-700 hover:bg-green-100 flex gap-1 items-center",children:[e.jsx(ae,{className:"h-3 w-3"})," Card Saved"]}):e.jsxs(f,{variant:"outline",className:"text-muted-foreground flex gap-1 items-center",children:[e.jsx(te,{className:"h-3 w-3"})," No Card Saved"]})]}),!(t!=null&&t.global_enabled)&&e.jsx(ne,{className:"text-destructive font-medium",children:"Auto Top-up is currently disabled by the administrator."})]}),e.jsxs(M,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Enable Auto Top-Up"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Automatically add balance when it drops below the threshold"})]}),e.jsx(Fe,{checked:_,onCheckedChange:xe,disabled:!(t!=null&&t.global_enabled)})]}),_&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-3",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(g,{children:"Min Balance Threshold"}),e.jsx(y,{type:"number",value:F,onChange:s=>O(s.target.value)})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(g,{children:"Top-Up Amount"}),e.jsx(y,{type:"number",value:b,onChange:s=>K(s.target.value)})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(g,{children:"Monthly Max Cap"}),e.jsx(y,{type:"number",value:$,onChange:s=>Y(s.target.value)})]})]}),e.jsxs("div",{className:"flex justify-between items-center pt-2",children:[e.jsxs("p",{className:"text-[11px] text-muted-foreground max-w-[250px]",children:["A 22% Stripe VAT will be added to each auto top-up. Total charge: ",a(parseFloat(b)*1.22)]}),e.jsxs(d,{size:"sm",onClick:pe,disabled:C.isPending,children:[C.isPending?e.jsx(U,{className:"h-3 w-3 animate-spin mr-1"}):e.jsx(Ne,{className:"h-3 w-3 mr-1"}),"Save Preferences"]})]})]})]})]}),e.jsx("div",{className:"grid gap-4 sm:grid-cols-3",children:(de||[]).map(s=>{const i=s.id===H;return e.jsxs(A,{className:i?"border-primary ring-2 ring-primary/20":"",children:[e.jsx(T,{className:"pb-2",children:e.jsxs(P,{className:"flex items-center justify-between text-lg",children:[s.name,i&&e.jsx(f,{children:"Active"})]})}),e.jsxs(M,{className:"space-y-4",children:[e.jsxs("p",{className:"text-3xl font-bold",children:[a(s.price_cents/100),e.jsxs("span",{className:"text-base font-normal text-muted-foreground",children:["/",(s.id==="datacenter","GB")]})]}),e.jsx("ul",{className:"space-y-1.5",children:s.features.map(c=>e.jsxs("li",{className:"flex items-start gap-2 text-sm text-muted-foreground",children:[e.jsx(ae,{className:"mt-0.5 h-4 w-4 shrink-0 text-primary"}),c]},c))}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(d,{variant:i?"outline":"default",className:"w-full",disabled:i,onClick:()=>he(s.id),children:i?"Active Product":"Select Product"}),!i&&e.jsxs("div",{className:"flex flex-col gap-2",children:[j.stripe&&e.jsxs(d,{variant:"secondary",className:"w-full gap-2",disabled:w,onClick:async()=>{x(!0);try{const{url:c}=await u.createProductCheckout(s.id,1);window.location.href=c}catch(c){r({title:"Purchase Error",description:c.message,variant:"destructive"})}finally{x(!1)}},children:[e.jsx(se,{className:"h-4 w-4"})," Buy with Card"]}),j.cryptomus&&e.jsxs(d,{variant:"outline",className:"w-full gap-2 border-primary/20 hover:border-primary/50",disabled:w,onClick:async()=>{x(!0);try{const{url:c}=await u.createCryptomusProductCheckout(s.id,1);window.location.href=c}catch(c){r({title:"Purchase Error",description:c.message,variant:"destructive"})}finally{x(!1)}},children:[e.jsx(R,{className:"h-4 w-4 text-orange-500"})," Buy with Crypto"]})]})]})]})]},s.id)})}),e.jsxs(A,{children:[e.jsx(T,{children:e.jsx(P,{className:"text-lg",children:p("nav.invoices")})}),e.jsx(M,{className:"p-0",children:e.jsxs(Se,{children:[e.jsx(Ae,{children:e.jsxs(re,{children:[e.jsx(k,{children:"Period"}),e.jsx(k,{children:"Amount"}),e.jsx(k,{children:"Status"}),e.jsx(k,{className:"text-right",children:"Date"})]})}),e.jsx(Te,{children:(ue||[]).map(s=>e.jsxs(re,{children:[e.jsx(E,{className:"font-medium",children:s.period}),e.jsx(E,{children:a(s.amount_cents/100)}),e.jsx(E,{children:e.jsx(f,{variant:Ve[s.status]??"secondary",children:s.status})}),e.jsxs(E,{className:"text-right text-sm text-muted-foreground space-x-2",children:[e.jsx("span",{children:new Date(s.created_at).toLocaleDateString()}),s.pdf_url&&e.jsx(d,{variant:"ghost",size:"icon",className:"h-7 w-7",asChild:!0,title:"Download PDF",children:e.jsx("a",{href:s.pdf_url,target:"_blank",rel:"noopener noreferrer",children:e.jsx(we,{className:"h-3.5 w-3.5"})})})]})]},s.id))})]})})]})]}),e.jsx(Le,{open:oe,onOpenChange:Q,defaultAmount:v})]})}export{We as default};
