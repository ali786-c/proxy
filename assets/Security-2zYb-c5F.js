import{j as e,x as a}from"./ui-CeaNA1b8.js";import{r as i,ad as K,w as W,ab as X,ar as Z,aw as u,am as L,o as D}from"./vendor-CSZBJNtL.js";import{S as $}from"./SEOHead-Dfo6dpCS.js";import{C as h,a as S,b as k,d as ee,c as p}from"./card-clxFFivi.js";import{a as se,B as M,I as P,t}from"./index-Dr9N_a8S.js";import{L as A}from"./label-5YbheAOU.js";import{I as ae,a as te,b as l}from"./input-otp-g34q1mRh.js";import{k as re,l as ie,m as ne,n as le,o as ce}from"./use-backend-WLUrADBk.js";import"./useMutation-8NIbHAl5.js";function ge(){const{user:f}=se(),[d,c]=i.useState("idle"),[o,j]=i.useState(""),[x,R]=i.useState(!1),[F,q]=i.useState([]),[g,E]=i.useState(""),[T,v]=i.useState(!1),{data:r,isLoading:z,refetch:G}=re(),N=ie(),y=ne(),n=!!(f!=null&&f.is_2fa_enabled),{data:b}=le(n),H=ce(),[m,I]=i.useState(""),[w,_]=i.useState(""),[O,B]=i.useState(!1),V=async()=>{if(!m||m!==w){t({title:"Validation Error",description:"Passwords do not match.",variant:"destructive"});return}B(!0);try{await H.mutateAsync({password:m,password_confirmation:w}),t({title:"Password updated successfully"}),I(""),_("")}catch(s){t({title:"Error",description:s.message,variant:"destructive"})}finally{B(!1)}},U=()=>{G(),c("setup")},Y=async()=>{if(o.length!==6){t({title:"Invalid code",description:"Enter a 6-digit code",variant:"destructive"});return}try{const s=await N.mutateAsync(o);q(s.recovery_codes),c("idle"),j(""),t({title:"2FA Enabled",description:"Your account is now protected."})}catch(s){t({title:"Verification failed",description:s.message,variant:"destructive"})}},Q=async()=>{if(!g){t({title:"Password required",description:"Please enter your password to disable 2FA.",variant:"destructive"});return}try{await y.mutateAsync({password:g}),t({title:"2FA Disabled",description:"Two-factor authentication has been turned off."}),E(""),v(!1)}catch(s){t({title:"Error",description:s.message,variant:"destructive"})}},C=F.length>0?F:(b==null?void 0:b.recovery_codes)||[];return e.jsxs(e.Fragment,{children:[e.jsx($,{title:"Security & 2FA",noindex:!0}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Security & 2FA"}),e.jsxs(h,{children:[e.jsx(S,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[n?e.jsx(K,{className:"h-8 w-8 text-success"}):e.jsx(W,{className:"h-8 w-8 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx(k,{className:"text-lg",children:"Two-Factor Authentication (TOTP)"}),e.jsx(ee,{children:"Add an extra layer of security using an authenticator app like Google Authenticator or Authy."})]}),e.jsx(M,{variant:n?"default":"secondary",className:"ml-auto",children:n?"Enabled":"Disabled"})]})}),e.jsxs(p,{className:"space-y-4",children:[n&&d==="idle"&&e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx("p",{className:"text-sm text-green-600 font-medium",children:"Two-factor authentication is active on your account."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(a,{variant:"outline",size:"sm",onClick:()=>R(!x),children:[x?e.jsx(X,{className:"mr-1 h-4 w-4"}):e.jsx(Z,{className:"mr-1 h-4 w-4"}),x?"Hide":"Show"," Backup Codes"]}),!T&&e.jsx(a,{variant:"destructive",size:"sm",onClick:()=>v(!0),children:"Disable 2FA"})]}),T&&e.jsxs("div",{className:"flex flex-col gap-3 max-w-sm rounded-lg border bg-muted/50 p-4",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(A,{htmlFor:"disable-pass",children:"Confirm Password to Disable"}),e.jsx(P,{id:"disable-pass",type:"password",placeholder:"Your password",value:g,onChange:s=>E(s.target.value)})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(a,{variant:"destructive",onClick:Q,disabled:y.isPending,className:"flex-1",children:[y.isPending?e.jsx(u,{className:"mr-2 h-4 w-4 animate-spin"}):null,"Confirm Disable"]}),e.jsx(a,{variant:"ghost",onClick:()=>v(!1),className:"flex-1",children:"Cancel"})]})]}),x&&C.length>0&&e.jsx(h,{className:"bg-muted",children:e.jsxs(p,{className:"py-3",children:[e.jsx("p",{className:"text-xs font-medium mb-2",children:"Save these backup codes in a safe place:"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:C.map((s,J)=>e.jsx("code",{className:"text-xs font-mono bg-background px-2 py-1.5 rounded border",children:s},J))}),e.jsxs(a,{variant:"ghost",size:"sm",className:"mt-3 w-full",onClick:()=>{navigator.clipboard.writeText(C.join(`
`)),t({title:"Copied to clipboard"})},children:[e.jsx(L,{className:"mr-2 h-3 w-3"})," Copy All Codes"]})]})})]}),!n&&d==="idle"&&e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Protect your account by requiring a security code whenever you sign in."}),e.jsxs(a,{onClick:U,className:"w-fit",children:[e.jsx(D,{className:"mr-2 h-4 w-4"})," Enable 2FA"]})]}),d==="setup"&&e.jsx("div",{className:"space-y-6",children:z?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 space-y-4",children:[e.jsx(u,{className:"h-10 w-10 animate-spin text-primary"}),e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Preparing your secure connection..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-primary text-primary-foreground text-sm font-bold",children:"1"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold leading-none pt-1.5",children:"Scan the QR Code"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Open your authenticator app (like Google Authenticator, Authy, or Microsoft Authenticator) and scan the image below."})]})]}),e.jsx("div",{className:"flex flex-col items-center justify-center py-2",children:e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute -inset-1 bg-gradient-to-r from-primary/20 to-primary/10 rounded-2xl blur opacity-75 group-hover:opacity-100 transition duration-1000 group-hover:duration-200"}),e.jsx("div",{className:"relative rounded-xl border bg-white p-6 shadow-xl",children:r!=null&&r.qr_code_svg?e.jsx("div",{dangerouslySetInnerHTML:{__html:r.qr_code_svg},className:"w-[180px] h-[180px] [&>svg]:w-full [&>svg]:h-full"}):e.jsx("div",{className:"w-[180px] h-[180px] flex items-center justify-center text-destructive bg-destructive/5 rounded-lg border border-dashed border-destructive/20",children:e.jsxs("p",{className:"text-xs text-center px-4",children:["Connection interrupted.",e.jsx("br",{}),"Please try again."]})})})]})}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-muted text-muted-foreground text-sm font-bold border",children:"2"}),e.jsxs("div",{className:"space-y-3 flex-1",children:[e.jsx("p",{className:"font-semibold leading-none pt-1.5",children:"Manual Setup Option"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"If you're unable to scan the code, you can manually enter this secret key into your app:"}),e.jsxs("div",{className:"flex items-center gap-2 group",children:[e.jsx("code",{className:"flex-1 bg-muted/50 px-4 py-3 rounded-lg text-sm font-mono border tracking-[0.2em] font-bold text-center select-all",children:r==null?void 0:r.secret}),e.jsx(a,{variant:"outline",size:"icon",className:"h-11 w-11 shrink-0",onClick:()=>{r&&(navigator.clipboard.writeText(r.secret),t({title:"Secret key copied",description:"You can now paste it in your app."}))},children:e.jsx(L,{className:"h-4 w-4"})})]})]})]})]}),e.jsxs("div",{className:"flex gap-3 pt-6 border-t mt-4",children:[e.jsx(a,{variant:"ghost",onClick:()=>c("idle"),className:"flex-1",children:"Go Back"}),e.jsx(a,{onClick:()=>c("verify"),disabled:!r,className:"flex-1 shadow-lg shadow-primary/20",children:"I've scanned it, continue"})]})]})}),d==="verify"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold",children:"Step 2: Verify Setup"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Enter the 6-digit code from your app to confirm."})]}),e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(ae,{maxLength:6,value:o,onChange:j,children:e.jsxs(te,{className:"gap-2",children:[e.jsx(l,{index:0,className:"w-12 h-14 text-xl border-2"}),e.jsx(l,{index:1,className:"w-12 h-14 text-xl border-2"}),e.jsx(l,{index:2,className:"w-12 h-14 text-xl border-2"}),e.jsx(l,{index:3,className:"w-12 h-14 text-xl border-2"}),e.jsx(l,{index:4,className:"w-12 h-14 text-xl border-2"}),e.jsx(l,{index:5,className:"w-12 h-14 text-xl border-2"})]})})}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t",children:[e.jsx(a,{variant:"outline",onClick:()=>{c("setup"),j("")},className:"flex-1",children:"Back"}),e.jsxs(a,{onClick:Y,disabled:o.length!==6||N.isPending,className:"flex-1",children:[N.isPending?e.jsx(u,{className:"mr-2 h-4 w-4 animate-spin"}):null,"Confirm & Enable"]})]})]})]})]}),e.jsxs(h,{children:[e.jsx(S,{children:e.jsx(k,{className:"text-lg",children:"Change Password"})}),e.jsxs(p,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2 max-w-sm",children:[e.jsx(A,{children:"New Password"}),e.jsx(P,{type:"password",placeholder:"••••••••",value:m,onChange:s=>I(s.target.value)})]}),e.jsxs("div",{className:"space-y-2 max-w-sm",children:[e.jsx(A,{children:"Confirm New Password"}),e.jsx(P,{type:"password",placeholder:"••••••••",value:w,onChange:s=>_(s.target.value)})]}),e.jsxs(a,{onClick:V,disabled:O,children:[O?e.jsx(u,{className:"mr-2 h-4 w-4 animate-spin"}):null,"Update Password"]})]})]}),e.jsxs(h,{children:[e.jsx(S,{children:e.jsx(k,{className:"text-lg",children:"Active Sessions"})}),e.jsx(p,{children:e.jsxs("div",{className:"flex items-center justify-between rounded-lg border p-4 bg-muted/20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-background rounded-full border shadow-sm",children:e.jsx(D,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Current Session"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:navigator.userAgent.split(" ").pop()})]})]}),e.jsx(M,{variant:"default",className:"bg-green-100 text-green-700 hover:bg-green-100",children:"Live now"})]})})]})]})]})}export{ge as default};
