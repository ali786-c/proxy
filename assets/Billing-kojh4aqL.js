import{j as e,x as u}from"./ui-DhchgSRK.js";import{r as l,t as ie,W as Ne,aA as Y,aG as Ce,a1 as ne,aw as z,ay as Se,a3 as Ae,d as re,aH as Te,D as Pe}from"./vendor-Dios4bpT.js";import{S as Me}from"./SEOHead-DxDVfQjj.js";import{C as k,a as _,b as F,d as le,c as E}from"./card-ClKFnvWz.js";import{T as ke,a as _e,b as ce,c as B,d as Fe,e as $}from"./table-BODbY_8L.js";import{j as Ee,l as Be,b as $e,u as qe,d as De,k as G,c,I as g,B as v,m as Ie}from"./index-CtD57vH8.js";import{L as b}from"./label-CHENNY20.js";import{S as Le}from"./switch-B1CpkYu0.js";import{u as Ve}from"./useMutation-Bd4P-yhc.js";import{M as Ke}from"./ManualCryptoDialog-hZEOoP5s.js";const Qe=.22,q=5,Re={paid:"default",pending:"secondary",failed:"destructive"};function ts(){const m=Ee(),{toast:a}=Be(),{format:x,currency:D}=$e(),{t:y}=qe(),[oe]=l.useState("residential"),[I,de]=l.useState("50"),{gateways:f,autoTopUpEnabled:ue}=De(),[L,V]=l.useState(!1),[w,O]=l.useState("50"),[K,W]=l.useState("5"),[Q,J]=l.useState("500"),[o,me]=l.useState(null),[N,X]=l.useState(""),[C,h]=l.useState(!1),[he,Z]=l.useState(!1),[n,R]=l.useState(null),[ee,se]=l.useState(!1),{data:t,isLoading:Ue}=G({queryKey:["top-up-settings"],queryFn:()=>c.getTopUpSettings()}),[He,U]=l.useState(!1);l.useEffect(()=>{const s=new URLSearchParams(window.location.search);if(s.get("success")==="true"){const i=s.get("session_id");window.history.replaceState({},document.title,window.location.pathname),i?c.verifySession(i).then(()=>{m.invalidateQueries({queryKey:["me"]}),m.invalidateQueries({queryKey:["invoices"]}),m.invalidateQueries({queryKey:["stats"]}),U(!0)}).catch(r=>{r.message&&r.message.includes("already")?(m.invalidateQueries({queryKey:["me"]}),U(!0)):(a({title:"Processing Payment",description:"Your payment was received. It may take a minute for your balance to update. Please refresh shortly.",variant:"default"}),m.invalidateQueries({queryKey:["me"]}))}):(m.invalidateQueries({queryKey:["me"]}),m.invalidateQueries({queryKey:["invoices"]}),U(!0))}else s.get("setup_success")==="true"?(a({title:"Card Saved",description:"Your payment method has been securely saved for auto top-up."}),window.history.replaceState({},document.title,window.location.pathname)):s.get("setup_canceled")==="true"?(a({title:"Setup Canceled",description:"Card setup was canceled. Auto top-up remains disabled.",variant:"destructive"}),window.history.replaceState({},document.title,window.location.pathname)):s.get("canceled")==="true"&&(a({title:"Payment Canceled",description:"Your payment was canceled. No charges were made.",variant:"destructive"}),window.history.replaceState({},document.title,window.location.pathname))},[]),l.useMemo(()=>{t&&(V(t.enabled),O(t.amount.toString()),W(t.threshold.toString()),J(t.max_monthly.toString()))},[t]);const S=Ve({mutationFn:s=>c.updateTopUpSettings(s),onSuccess:()=>{m.invalidateQueries({queryKey:["top-up-settings"]}),a({title:"Settings Saved",description:"Your auto top-up preferences have been updated."})},onError:s=>a({title:"Error",description:s.message,variant:"destructive"})}),{data:pe}=G({queryKey:["plans"],queryFn:()=>c.getPlans()}),{data:xe}=G({queryKey:["invoices"],queryFn:()=>c.getInvoices()}),p=parseFloat(I)||0,H=n?n.discount:0,A=Math.max(0,p-H),T=o==="cryptomus"||o==="manual",te=T?0:A*Qe,P=A+te,ye=s=>D.exchange_rate*s,d=D.symbol,j=ye(q),M=p<j,fe=async()=>{if(N.trim()){if(p<q){a({title:"Error",description:`Please enter an amount of at least ${x(q)} first.`,variant:"destructive"});return}se(!0);try{const s=await c.validateCoupon(N.toUpperCase(),p);s.valid&&(R({code:s.code,discount:s.discount,type:s.type,value:s.value}),a({title:"Coupon Applied",description:`You saved ${x(s.discount)}!`}))}catch(s){R(null),a({title:"Invalid Coupon",description:s.message||"This code is not valid.",variant:"destructive"})}finally{se(!1)}}},je=s=>{a({title:"Product Selected",description:`Switching to ${s}.`})},ge=async s=>{if(V(s),s&&t&&!t.has_payment_method)try{const{url:i}=await c.createSetupIntent();window.location.href=i}catch(i){a({title:"Setup Error",description:i.message,variant:"destructive"}),V(!1)}else S.mutate({enabled:s,threshold:parseFloat(K),amount:parseFloat(w),max_monthly:parseFloat(Q)})},ve=()=>{S.mutate({enabled:L,threshold:parseFloat(K),amount:parseFloat(w),max_monthly:parseFloat(Q)})},be=async()=>{if(M){a({title:"Minimum not met",description:`Minimum purchase is ${d}${j.toFixed(2)}.`,variant:"destructive"});return}if(!o){a({title:"Select a payment method",description:"Please choose how you'd like to pay.",variant:"destructive"});return}if(o==="cryptomus"){h(!0);try{const{url:s}=await c.createCryptomusCheckout(p,n==null?void 0:n.code);window.location.href=s}catch(s){a({title:"Checkout Error",description:s.message,variant:"destructive"})}finally{h(!1)}}else if(o==="stripe"){h(!0);try{const{url:s}=await c.createCheckout(P,A,D.code);window.location.href=s}catch(s){a({title:"Checkout Error",description:s.message,variant:"destructive"})}finally{h(!1)}}else o==="manual"?Z(!0):a({title:`Pay with ${o}`,description:`Redirecting to ${o} checkout for ${x(P)}...`})},ae=[{id:"stripe",name:"Card (Stripe)",subtitle:"Credit/Debit Card",icon:ie,vatLabel:"+22% VAT",enabled:f.stripe},{id:"paypal",name:"PayPal",subtitle:"PayPal Balance",icon:Ne,vatLabel:"+22% VAT",enabled:f.paypal},{id:"cryptomus",name:"Crypto",subtitle:"Automated via Cryptomus",icon:Y,vatLabel:"No VAT",enabled:f.cryptomus},{id:"manual",name:"Binance Pay",subtitle:"Manual Transfer",icon:Y,vatLabel:"No VAT",enabled:f.crypto}],we=ae.length>0;return e.jsxs(e.Fragment,{children:[e.jsx(Me,{title:"Account & Billing",noindex:!0}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Account & Billing"}),e.jsxs(k,{children:[e.jsxs(_,{children:[e.jsxs(F,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Ce,{className:"h-5 w-5"})," ",y("billing.topUp")]}),e.jsxs(le,{children:[y("billing.minPurchaseTitle"),": ",d,j.toFixed(2),". 22% VAT applies to card & PayPal payments. Crypto is VAT-free."]})]}),e.jsxs(E,{className:"space-y-5",children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2 max-w-lg",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(b,{children:"Amount"}),e.jsx(g,{type:"number",value:I,onChange:s=>de(s.target.value),min:j,step:"0.01",placeholder:`Min ${d}${j.toFixed(2)}`,className:M&&p>0?"border-destructive ring-destructive":""}),M&&p>0&&e.jsxs("p",{className:"text-sm text-destructive font-medium flex items-center gap-1.5 mt-1.5 p-2 bg-destructive/10 rounded-md",children:[e.jsx(ne,{className:"h-4 w-4"}),"Minimum purchase amount is ",d,j.toFixed(2)]})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(b,{children:"Promo Code (optional)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{placeholder:"WELCOME20",value:N,onChange:s=>X(s.target.value),className:n?"border-green-500 bg-green-500/5":"",disabled:!!n}),n?e.jsx(u,{variant:"outline",size:"sm",onClick:()=>{R(null),X("")},children:"Remove"}):e.jsx(u,{variant:"outline",size:"sm",className:"shrink-0",onClick:fe,disabled:ee||!N.trim(),children:ee?e.jsx(z,{className:"h-4 w-4 animate-spin"}):"Apply"})]}),n&&e.jsxs("p",{className:"text-[11px] text-green-600 font-medium",children:[" Coupon applied: ",n.type==="percentage"?`${n.value}%`:`${x(n.value)}`," off"]})]})]}),!we&&e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"No payment methods are currently available. Please contact support."}),e.jsx("div",{className:"grid gap-3 sm:grid-cols-3",children:ae.map(s=>{const i=s.enabled,r=o===s.id;return e.jsxs(u,{variant:r?"default":"outline",className:`h-auto py-4 flex-col gap-1 relative ${i?"":"opacity-40 cursor-not-allowed"}`,disabled:!i,onClick:()=>me(s.id),children:[e.jsx(s.icon,{className:"h-6 w-6"}),e.jsx("span",{className:"font-semibold",children:s.name}),e.jsx("span",{className:"text-[11px] font-normal opacity-80",children:s.subtitle}),e.jsx(v,{variant:s.id==="crypto"||s.id==="manual"?"default":"secondary",className:"text-[10px] mt-1",children:s.vatLabel}),!i&&e.jsx("span",{className:"text-[10px] font-normal",children:"Not available"})]},s.id)})}),o&&p>=q&&e.jsxs("div",{className:"rounded-lg border bg-muted/30 p-4 max-w-sm space-y-2",children:[e.jsx("h4",{className:"text-sm font-semibold",children:y("billing.orderSummary")}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:y("billing.subtotal")}),e.jsxs("span",{children:[d,A.toFixed(2)]})]}),H>0&&e.jsxs("div",{className:"flex justify-between text-sm text-green-600 font-medium font-mono",children:[e.jsxs("span",{children:["Discount (",n==null?void 0:n.code,")"]}),e.jsxs("span",{children:["-",d,H.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"flex items-center gap-1",children:["VAT (22%)",T&&e.jsx(Se,{className:"h-3 w-3 text-muted-foreground"})]}),e.jsx("span",{className:T?"line-through text-muted-foreground":"",children:T?`${d}0.00 â€” exempt`:`${d}${te.toFixed(2)}`})]}),e.jsx(Ie,{}),e.jsxs("div",{className:"flex justify-between text-sm font-bold",children:[e.jsx("span",{children:y("common.total")}),e.jsxs("span",{children:[d,P.toFixed(2)]})]}),e.jsxs(u,{className:"w-full mt-2",onClick:be,disabled:M||C,children:[C?e.jsx(z,{className:"mr-2 h-4 w-4 animate-spin"}):null,y("common.pay")," ",d,P.toFixed(2)]})]})]})]}),ue&&e.jsxs(k,{className:t!=null&&t.global_enabled?"":"opacity-60 grayscale-[0.5]",children:[e.jsxs(_,{children:[e.jsxs(F,{className:"flex items-center justify-between text-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ae,{className:"h-5 w-5"})," Auto Top-Up"]}),t!=null&&t.has_payment_method?e.jsxs(v,{variant:"secondary",className:"bg-green-100 text-green-700 hover:bg-green-100 flex gap-1 items-center",children:[e.jsx(re,{className:"h-3 w-3"})," Card Saved"]}):e.jsxs(v,{variant:"outline",className:"text-muted-foreground flex gap-1 items-center",children:[e.jsx(ne,{className:"h-3 w-3"})," No Card Saved"]})]}),!(t!=null&&t.global_enabled)&&e.jsx(le,{className:"text-destructive font-medium",children:"Auto Top-up is currently disabled by the administrator."})]}),e.jsxs(E,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Enable Auto Top-Up"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Automatically add balance when it drops below the threshold"})]}),e.jsx(Le,{checked:L,onCheckedChange:ge,disabled:!(t!=null&&t.global_enabled)})]}),L&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-3",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(b,{children:"Min Balance Threshold"}),e.jsx(g,{type:"number",value:K,onChange:s=>W(s.target.value)})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(b,{children:"Top-Up Amount"}),e.jsx(g,{type:"number",value:w,onChange:s=>O(s.target.value)})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(b,{children:"Monthly Max Cap"}),e.jsx(g,{type:"number",value:Q,onChange:s=>J(s.target.value)})]})]}),e.jsxs("div",{className:"flex justify-between items-center pt-2",children:[e.jsxs("p",{className:"text-[11px] text-muted-foreground max-w-[250px]",children:["A 22% Stripe VAT will be added to each auto top-up. Total charge: ",x(parseFloat(w)*1.22)]}),e.jsxs(u,{size:"sm",onClick:ve,disabled:S.isPending,children:[S.isPending?e.jsx(z,{className:"h-3 w-3 animate-spin mr-1"}):e.jsx(Te,{className:"h-3 w-3 mr-1"}),"Save Preferences"]})]})]})]})]}),e.jsx("div",{className:"grid gap-4 sm:grid-cols-3",children:(pe||[]).map(s=>{const i=s.id===oe;return e.jsxs(k,{className:i?"border-primary ring-2 ring-primary/20":"",children:[e.jsx(_,{className:"pb-2",children:e.jsxs(F,{className:"flex items-center justify-between text-lg",children:[s.name,i&&e.jsx(v,{children:"Active"})]})}),e.jsxs(E,{className:"space-y-4",children:[e.jsxs("p",{className:"text-3xl font-bold",children:[x(s.price_cents/100),e.jsxs("span",{className:"text-base font-normal text-muted-foreground",children:["/",(s.id==="datacenter","GB")]})]}),e.jsx("ul",{className:"space-y-1.5",children:s.features.map(r=>e.jsxs("li",{className:"flex items-start gap-2 text-sm text-muted-foreground",children:[e.jsx(re,{className:"mt-0.5 h-4 w-4 shrink-0 text-primary"}),r]},r))}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{variant:i?"outline":"default",className:"w-full",disabled:i,onClick:()=>je(s.id),children:i?"Active Product":"Select Product"}),!i&&e.jsxs("div",{className:"flex flex-col gap-2",children:[f.stripe&&e.jsxs(u,{variant:"secondary",className:"w-full gap-2",disabled:C,onClick:async()=>{h(!0);try{const{url:r}=await c.createProductCheckout(s.id,1);window.location.href=r}catch(r){a({title:"Purchase Error",description:r.message,variant:"destructive"})}finally{h(!1)}},children:[e.jsx(ie,{className:"h-4 w-4"})," Buy with Card"]}),f.cryptomus&&e.jsxs(u,{variant:"outline",className:"w-full gap-2 border-primary/20 hover:border-primary/50",disabled:C,onClick:async()=>{h(!0);try{const{url:r}=await c.createCryptomusProductCheckout(s.id,1);window.location.href=r}catch(r){a({title:"Purchase Error",description:r.message,variant:"destructive"})}finally{h(!1)}},children:[e.jsx(Y,{className:"h-4 w-4 text-orange-500"})," Buy with Crypto"]})]})]})]})]},s.id)})}),e.jsxs(k,{children:[e.jsx(_,{children:e.jsx(F,{className:"text-lg",children:y("nav.invoices")})}),e.jsx(E,{className:"p-0",children:e.jsxs(ke,{children:[e.jsx(_e,{children:e.jsxs(ce,{children:[e.jsx(B,{children:"Period"}),e.jsx(B,{children:"Amount"}),e.jsx(B,{children:"Status"}),e.jsx(B,{className:"text-right",children:"Date"})]})}),e.jsx(Fe,{children:(xe||[]).map(s=>e.jsxs(ce,{children:[e.jsx($,{className:"font-medium",children:s.period}),e.jsx($,{children:x(s.amount_cents/100)}),e.jsx($,{children:e.jsx(v,{variant:Re[s.status]??"secondary",children:s.status})}),e.jsxs($,{className:"text-right text-sm text-muted-foreground space-x-2",children:[e.jsx("span",{children:new Date(s.created_at).toLocaleDateString()}),s.pdf_url&&e.jsx(u,{variant:"ghost",size:"icon",className:"h-7 w-7",asChild:!0,title:"Download PDF",children:e.jsx("a",{href:s.pdf_url,target:"_blank",rel:"noopener noreferrer",children:e.jsx(Pe,{className:"h-3.5 w-3.5"})})})]})]},s.id))})]})})]})]}),e.jsx(Ke,{open:he,onOpenChange:Z,defaultAmount:I})]})}export{ts as default};
