import{j as e,x as c}from"./ui-DhchgSRK.js";import{r as d,a3 as b,U as re,as as O,E as ae,ac as te,aH as ie}from"./vendor-Dios4bpT.js";import{j as le,b as ne,k as ce,B as J,x as u,M as S,t as f,I as w,A as de,y as W}from"./index-WnGPYx7J.js";import{J as oe,K as me,L as xe}from"./use-backend-C4V2rwg1.js";import{C as x,c as h,a as C,b as R,d as T}from"./card-ClKFnvWz.js";import{T as k,a as E,b as o,c as l,d as U,e as a}from"./table-BODbY_8L.js";import{T as he,a as ue,b as P,c as I}from"./tabs-CR_i008t.js";import{S as fe}from"./switch-Bs7R8iY3.js";import{L}from"./label-CHENNY20.js";import{f as je}from"./format-sbWH3_uq.js";import"./useMutation-DYRj_MQN.js";function ke(){var $,B,V;const j=le(),{format:N}=ne(),{data:t,isLoading:X}=oe(),[Y,pe]=d.useState(""),[y,M]=d.useState(1),{data:i,isLoading:Z}=me(Y,y),A=xe(),[r,p]=d.useState(null),[F,q]=d.useState(!1),[_,ee]=d.useState(""),[z,K]=d.useState(!1),[D,Q]=d.useState([]),{data:g}=ce({queryKey:["admin","settings","referral"],queryFn:async()=>u.get("/admin/settings",W())}),H=async()=>{if(_.trim()){K(!0);try{const s=await u.get(`/admin/users?search=${encodeURIComponent(_)}`,de(W()));Q(s)}catch{f({title:"Search Error",description:"Failed to fetch users.",variant:"destructive"})}finally{K(!1)}}};g&&!r&&p({referral_system_enabled:g.referral_system_enabled==="1",referral_commission_percentage:g.referral_commission_percentage||"10",referral_hold_days:g.referral_hold_days||"14"});const se=async()=>{q(!0);try{await u.post("/admin/settings",S,{referral_system_enabled:r.referral_system_enabled?"1":"0",referral_commission_percentage:r.referral_commission_percentage,referral_hold_days:r.referral_hold_days}),f({title:"Settings Saved",description:"Referral configuration updated successfully."}),j.invalidateQueries({queryKey:["admin","settings"]})}catch{f({title:"Error",description:"Failed to save settings.",variant:"destructive"})}finally{q(!1)}};return X?e.jsxs("div",{className:"p-10 text-center",children:[e.jsx(b,{className:"h-6 w-6 animate-spin mx-auto mb-2"})," Loading..."]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Referral Management"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Monitor and configure the platform referral program."})]})}),e.jsxs("div",{className:"grid gap-4 sm:grid-cols-3",children:[e.jsx(x,{children:e.jsx(h,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"p-3 bg-primary/10 rounded-full",children:e.jsx(re,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Total Referrals"}),e.jsx("p",{className:"text-2xl font-bold",children:t==null?void 0:t.total_referrals})]})]})})}),e.jsx(x,{children:e.jsx(h,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"p-3 bg-warning/10 rounded-full",children:e.jsx(O,{className:"h-6 w-6 text-warning"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Pending Payouts"}),e.jsx("p",{className:"text-2xl font-bold",children:N((t==null?void 0:t.total_pending)||0)})]})]})})}),e.jsx(x,{children:e.jsx(h,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"p-3 bg-success/10 rounded-full",children:e.jsx(ae,{className:"h-6 w-6 text-success"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Total Paid Out"}),e.jsx("p",{className:"text-2xl font-bold",children:N((t==null?void 0:t.total_completed)||0)})]})]})})})]}),e.jsxs(he,{defaultValue:"overview",className:"space-y-4",children:[e.jsxs(ue,{children:[e.jsx(P,{value:"overview",children:"Earnings Overview"}),e.jsx(P,{value:"influencers",children:"Influencers"}),e.jsx(P,{value:"settings",children:"Global Settings"})]}),e.jsx(I,{value:"overview",className:"space-y-4",children:e.jsxs(x,{children:[e.jsxs(C,{className:"flex flex-row items-center justify-between space-y-0",children:[e.jsxs("div",{children:[e.jsx(R,{children:"Recent Earning Records"}),e.jsx(T,{children:"View all referral commissions across the platform."})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx(b,{className:"h-4 w-4 cursor-pointer text-muted-foreground hover:text-foreground",onClick:()=>j.invalidateQueries({queryKey:["admin","referrals","earnings"]})})})]}),e.jsxs(h,{children:[e.jsxs(k,{children:[e.jsx(E,{children:e.jsxs(o,{children:[e.jsx(l,{children:"Date"}),e.jsx(l,{children:"Referrer"}),e.jsx(l,{children:"Referred User"}),e.jsx(l,{children:"Amount"}),e.jsx(l,{children:"Status"}),e.jsx(l,{className:"text-right",children:"Action"})]})}),e.jsxs(U,{children:[($=i==null?void 0:i.data)==null?void 0:$.map(s=>{var n,v,m,G;return e.jsxs(o,{children:[e.jsx(a,{className:"text-xs",children:je(new Date(s.created_at),"MMM dd, yyyy")}),e.jsxs(a,{children:[e.jsx("div",{className:"text-sm font-medium",children:(n=s.referrer)==null?void 0:n.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:(v=s.referrer)==null?void 0:v.email})]}),e.jsxs(a,{children:[e.jsx("div",{className:"text-sm",children:(m=s.referred)==null?void 0:m.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:(G=s.referred)==null?void 0:G.email})]}),e.jsx(a,{className:"font-bold",children:N(s.amount)}),e.jsx(a,{children:e.jsx(J,{variant:s.status==="completed"?"success":"warning",className:"capitalize",children:s.status})}),e.jsxs(a,{className:"text-right",children:[s.status!=="completed"&&e.jsx(c,{variant:"ghost",size:"sm",className:"h-8 text-xs text-success hover:text-success hover:bg-success/10",onClick:async()=>{confirm("Mark this earning as completed and release to user?")&&(await u.post(`/admin/referrals/earnings/${s.id}/status`,S,{status:"completed"}),f({title:"Success",description:"Earning marked as completed."}),j.invalidateQueries({queryKey:["admin","referrals","earnings"]}))},children:"Mark Paid"}),s.status==="pending"&&e.jsx(c,{variant:"ghost",size:"sm",className:"h-8 text-xs text-destructive hover:text-destructive hover:bg-destructive/10",onClick:async()=>{confirm("Void this earning? It will not be paid out.")&&(await u.post(`/admin/referrals/earnings/${s.id}/status`,S,{status:"void"}),f({title:"Success",description:"Earning marked as void."}),j.invalidateQueries({queryKey:["admin","referrals","earnings"]}))},children:"Void"})]})]},s.id)}),(!i||((B=i.data)==null?void 0:B.length)===0)&&e.jsx(o,{children:e.jsx(a,{colSpan:5,className:"text-center py-10 text-muted-foreground",children:Z?"Loading...":"No earning records found."})})]})]}),(i==null?void 0:i.last_page)>1&&e.jsxs("div",{className:"flex items-center justify-between mt-4 border-t pt-4",children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Page ",i.current_page," of ",i.last_page," (",i.total," records)"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{variant:"outline",size:"sm",disabled:y===1,onClick:()=>M(s=>s-1),children:"Previous"}),e.jsx(c,{variant:"outline",size:"sm",disabled:y===i.last_page,onClick:()=>M(s=>s+1),children:"Next"})]})]})]})]})}),e.jsx(I,{value:"influencers",className:"space-y-4",children:e.jsxs(x,{children:[e.jsxs(C,{children:[e.jsx(R,{children:"Manage Influencers"}),e.jsx(T,{children:"Search for users and set custom commission rates."})]}),e.jsxs(h,{className:"space-y-6",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(w,{placeholder:"Search user by name, email or referral code...",value:_,onChange:s=>ee(s.target.value),onKeyDown:s=>s.key==="Enter"&&H()}),e.jsxs(c,{onClick:H,disabled:z,children:[z?e.jsx(b,{className:"h-4 w-4 animate-spin"}):e.jsx(te,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-2",children:"Search"})]})]}),D.length>0&&e.jsxs(k,{children:[e.jsx(E,{children:e.jsxs(o,{children:[e.jsx(l,{children:"User"}),e.jsx(l,{children:"Current Rate"}),e.jsx(l,{className:"text-right",children:"Action"})]})}),e.jsx(U,{children:D.map(s=>e.jsxs(o,{children:[e.jsxs(a,{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.email})]}),e.jsx(a,{children:e.jsx(J,{variant:"secondary",children:s.custom_referral_rate?`${s.custom_referral_rate}%`:"Default"})}),e.jsx(a,{className:"text-right",children:e.jsx(c,{variant:"outline",size:"sm",onClick:()=>{const n=prompt(`Enter custom rate (%) for ${s.name}:`,s.custom_referral_rate||"15");n!==null&&(A.mutate({user_id:s.id,custom_rate:parseFloat(n)}),Q(v=>v.map(m=>m.id===s.id?{...m,custom_referral_rate:parseFloat(n)}:m)))},children:"Set Rate"})})]},s.id))})]}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsxs("h3",{className:"text-sm font-semibold mb-3 flex items-center gap-2",children:[e.jsx(O,{className:"h-4 w-4"})," Top Referrers"]}),e.jsxs(k,{children:[e.jsx(E,{children:e.jsxs(o,{children:[e.jsx(l,{children:"User"}),e.jsx(l,{className:"text-center",children:"Total Referrals"}),e.jsx(l,{className:"text-right",children:"Action"})]})}),e.jsx(U,{children:(V=t==null?void 0:t.top_referrers)==null?void 0:V.map(s=>e.jsxs(o,{children:[e.jsxs(a,{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.email})]}),e.jsx(a,{className:"text-center",children:s.referrals_count}),e.jsx(a,{className:"text-right",children:e.jsx(c,{variant:"outline",size:"sm",onClick:()=>{const n=prompt("Enter custom commission rate (%) for this user:","15");n!==null&&A.mutate({user_id:s.id,custom_rate:parseFloat(n)})},children:"Set Rate"})})]},s.id))})]})]})]})]})}),e.jsx(I,{value:"settings",children:e.jsxs(x,{children:[e.jsxs(C,{children:[e.jsx(R,{children:"Global Referral Settings"}),e.jsx(T,{children:"Configure how commissions are handled sitewide."})]}),e.jsxs(h,{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg bg-muted/30",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(L,{children:"Enable Referral Program"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Allow users to invite users and earn commissions."})]}),e.jsx(fe,{checked:r==null?void 0:r.referral_system_enabled,onCheckedChange:s=>p({...r,referral_system_enabled:s})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{children:"Default Commission Rate (%)"}),e.jsx(w,{type:"number",value:r==null?void 0:r.referral_commission_percentage,onChange:s=>p({...r,referral_commission_percentage:s.target.value})}),e.jsx("p",{className:"text-[10px] text-muted-foreground",children:"Standard percentage new referrers receive."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{children:"Escrow (Hold) Period (Days)"}),e.jsx(w,{type:"number",value:r==null?void 0:r.referral_hold_days,onChange:s=>p({...r,referral_hold_days:s.target.value})}),e.jsx("p",{className:"text-[10px] text-muted-foreground",children:"Days to hold funds before releasing to wallet."})]})]}),e.jsxs(c,{onClick:se,disabled:F,className:"w-full gap-2",children:[e.jsx(ie,{className:"h-4 w-4"}),F?"Saving...":"Save Configuration"]})]})]})})]})]})}export{ke as default};
