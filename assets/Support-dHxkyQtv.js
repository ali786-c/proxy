import{j as e,x as f}from"./ui-BvSIVwgG.js";import{r as x,aI as Q,ae as Y}from"./vendor-co0Zkaum.js";import{S as q}from"./SEOHead-DYU_qHlr.js";import{C,a as $,b as G,c as k}from"./card-0KzbiLUl.js";import{j as J,L as K,B as g,e as _,f as I,g as R,h as L,i as l,I as A,t as c,o as y,s as a,_ as W,Q as N,x as X}from"./index-Do4Gql9_.js";import{T as Z}from"./textarea-BY_AKs5L.js";import{T as ee,a as se,b as v,c as d,d as te,e as i}from"./table-gVuxc4b7.js";import{y as ae}from"./use-backend-D9AD9k-B.js";import"./useMutation-CurcCUL0.js";const re=y({id:N(),message:a(),is_admin_reply:W(),created_at:a(),attachment_url:a().nullable().optional(),attachment_name:a().nullable().optional()});y({id:N(),user_id:N(),subject:a(),status:a(),priority:a(),created_at:a(),updated_at:a(),user:y({email:a()}).nullable(),messages:X(re).optional()});const le={open:"secondary",in_progress:"default",resolved:"outline",closed:"outline"},D={low:"secondary",medium:"default",high:"destructive"};function pe(){J();const[m,O]=x.useState(""),[h,F]=x.useState("all"),[n,p]=x.useState(null),[u,S]=x.useState(""),[j,b]=x.useState(null),{data:o=[],isLoading:P,replyTicket:E,updateStatus:B,deleteTicket:T}=ae(),r=o.find(s=>s.id===n)||null,U=async()=>{if(!(!u.trim()&&!j||!n))try{await E.mutateAsync({id:n,message:u,attachment:j||void 0}),S(""),b(null),c({title:"Reply Sent"})}catch(s){c({title:"Error",description:s.message,variant:"destructive"})}},H=async s=>{if(n)try{await B.mutateAsync({id:n,status:s}),c({title:"Status Updated"})}catch(t){c({title:"Error",description:t.message,variant:"destructive"})}},V=async()=>{if(!(!n||!window.confirm("Are you sure you want to delete this ticket?")))try{await T.mutateAsync(n),p(null),c({title:"Ticket Deleted"})}catch(s){c({title:"Error",description:s.message,variant:"destructive"})}},w=o.filter(s=>{if(h!=="all"&&s.status!==h)return!1;if(m){const t=m.toLowerCase();return s.id.toLowerCase().includes(t)||s.user.toLowerCase().includes(t)||s.subject.toLowerCase().includes(t)}return!0}),z=o.filter(s=>s.status==="open").length,M=o.filter(s=>s.status==="in_progress").length;return P?e.jsx(K,{}):e.jsxs(e.Fragment,{children:[e.jsx(q,{title:"Admin — Support",noindex:!0}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Support Tickets"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[z," open · ",M," in progress · ",o.length," total"]})]})}),r?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(f,{variant:"outline",size:"sm",onClick:()=>p(null),children:"← Back"}),e.jsx(f,{variant:"destructive",size:"sm",onClick:V,disabled:T.isPending,children:"Delete Ticket"})]}),e.jsxs(C,{children:[e.jsx($,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(G,{className:"text-lg",children:r.subject}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["ID: ",r.id," · From: ",r.user]})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(g,{variant:D[r.priority],children:r.priority}),e.jsxs(_,{value:r.status,onValueChange:s=>H(s),children:[e.jsx(I,{className:"w-[140px] h-8 text-xs",children:e.jsx(R,{})}),e.jsxs(L,{children:[e.jsx(l,{value:"open",children:"Open"}),e.jsx(l,{value:"in_progress",children:"In Progress"}),e.jsx(l,{value:"resolved",children:"Resolved"}),e.jsx(l,{value:"closed",children:"Closed"})]})]})]})]})}),e.jsxs(k,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:r.messages.map((s,t)=>e.jsxs("div",{className:`rounded-lg p-3 text-sm ${s.sender==="support"?"bg-primary/5 ml-8":"bg-muted mr-8"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"font-medium text-xs",children:s.sender==="support"?"Support (You)":r.user}),e.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(s.time).toLocaleString()})]}),e.jsx("p",{children:s.text}),s.attachment_url&&e.jsx("div",{className:"mt-2 pt-2 border-t border-current/10",children:e.jsxs("a",{href:s.attachment_url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-1.5 text-xs hover:underline mt-1",children:[e.jsx(Q,{className:"h-3 w-3"}),s.attachment_name||"View Attachment"]})})]},t))}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Z,{value:u,onChange:s=>S(s.target.value),placeholder:"Type your reply...",rows:2,className:"flex-1"}),e.jsx(f,{onClick:U,disabled:!u.trim()&&!j,className:"self-end",children:"Send"})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("div",{className:"w-full max-w-xs",children:e.jsx(A,{type:"file",onChange:s=>{var t;return b(((t=s.target.files)==null?void 0:t[0])||null)},className:"h-8 text-xs cursor-pointer"})})})]})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"relative flex-1 min-w-[200px]",children:[e.jsx(Y,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(A,{placeholder:"Search tickets...",value:m,onChange:s=>O(s.target.value),className:"pl-9"})]}),e.jsxs(_,{value:h,onValueChange:F,children:[e.jsx(I,{className:"w-[150px]",children:e.jsx(R,{placeholder:"Status"})}),e.jsxs(L,{children:[e.jsx(l,{value:"all",children:"All"}),e.jsx(l,{value:"open",children:"Open"}),e.jsx(l,{value:"in_progress",children:"In Progress"}),e.jsx(l,{value:"resolved",children:"Resolved"}),e.jsx(l,{value:"closed",children:"Closed"})]})]})]}),e.jsx(C,{children:e.jsx(k,{className:"p-0",children:e.jsxs(ee,{children:[e.jsx(se,{children:e.jsxs(v,{children:[e.jsx(d,{children:"ID"}),e.jsx(d,{children:"User"}),e.jsx(d,{children:"Subject"}),e.jsx(d,{children:"Priority"}),e.jsx(d,{children:"Status"}),e.jsx(d,{className:"text-right",children:"Updated"})]})}),e.jsxs(te,{children:[w.map(s=>e.jsxs(v,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>p(s.id),children:[e.jsx(i,{className:"font-mono text-xs",children:s.id}),e.jsx(i,{className:"text-sm",children:s.user}),e.jsx(i,{className:"font-medium",children:s.subject}),e.jsx(i,{children:e.jsx(g,{variant:D[s.priority],className:"text-xs",children:s.priority})}),e.jsx(i,{children:e.jsx(g,{variant:le[s.status],className:"text-xs",children:s.status.replace("_"," ")})}),e.jsx(i,{className:"text-right text-xs text-muted-foreground",children:new Date(s.updated_at).toLocaleDateString()})]},s.id)),w.length===0&&e.jsx(v,{children:e.jsx(i,{colSpan:6,className:"h-24 text-center text-muted-foreground",children:"No tickets match."})})]})]})})})]})]})]})}export{pe as default};
