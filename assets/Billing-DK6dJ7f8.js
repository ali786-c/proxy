import{j as e,x as u}from"./ui-CeaNA1b8.js";import{r as l,t as te,H as ve,aA as R,aE as be,a3 as ae,aw as U,ay as we,a5 as Ne,d as ne,aF as Ce,D as Se}from"./vendor-CSZBJNtL.js";import{S as Ae}from"./SEOHead-BqhxOP7y.js";import{C as P,a as M,b as k,d as ie,c as E}from"./card-clxFFivi.js";import{T as Te,a as Pe,b as re,c as _,d as Me,e as B}from"./table-D3uMK-0w.js";import{j as ke,l as Ee,b as _e,u as Be,d as Fe,k as H,c as o,I as f,B as g,m as qe}from"./index-CYRX0wpi.js";import{L as v}from"./label-5YbheAOU.js";import{S as $e}from"./switch-mz5gzaIY.js";import{u as Le}from"./useMutation-t07llwxO.js";import{M as De}from"./ManualCryptoDialog-RH82ZHqT.js";const Ie=.22,m=5,Ve={paid:"default",pending:"secondary",failed:"destructive"};function Ze(){const h=ke(),{toast:n}=Ee(),{format:a,currency:le}=_e(),{t:y}=Be(),[ce]=l.useState("residential"),[b,z]=l.useState("50"),{gateways:j,autoTopUpEnabled:oe}=Fe(),[F,q]=l.useState(!1),[w,Y]=l.useState("50"),[$,O]=l.useState("5"),[L,G]=l.useState("500"),[d,de]=l.useState(null),[N,W]=l.useState(""),[C,p]=l.useState(!1),[ue,J]=l.useState(!1),[r,D]=l.useState(null),[X,Z]=l.useState(!1),{data:t,isLoading:Ke}=H({queryKey:["top-up-settings"],queryFn:()=>o.getTopUpSettings()}),[Qe,I]=l.useState(!1);l.useEffect(()=>{const s=new URLSearchParams(window.location.search);if(s.get("success")==="true"){const i=s.get("session_id");window.history.replaceState({},document.title,window.location.pathname),i?o.verifySession(i).then(()=>{h.invalidateQueries({queryKey:["me"]}),h.invalidateQueries({queryKey:["invoices"]}),h.invalidateQueries({queryKey:["stats"]}),I(!0)}).catch(()=>{h.invalidateQueries({queryKey:["me"]}),h.invalidateQueries({queryKey:["invoices"]}),I(!0)}):(h.invalidateQueries({queryKey:["me"]}),h.invalidateQueries({queryKey:["invoices"]}),I(!0))}else s.get("setup_success")==="true"?(n({title:"Card Saved",description:"Your payment method has been securely saved for auto top-up."}),window.history.replaceState({},document.title,window.location.pathname)):s.get("setup_canceled")==="true"?(n({title:"Setup Canceled",description:"Card setup was canceled. Auto top-up remains disabled.",variant:"destructive"}),window.history.replaceState({},document.title,window.location.pathname)):s.get("canceled")==="true"&&(n({title:"Payment Canceled",description:"Your payment was canceled. No charges were made.",variant:"destructive"}),window.history.replaceState({},document.title,window.location.pathname))},[]),l.useMemo(()=>{t&&(q(t.enabled),Y(t.amount.toString()),O(t.threshold.toString()),G(t.max_monthly.toString()))},[t]);const S=Le({mutationFn:s=>o.updateTopUpSettings(s),onSuccess:()=>{h.invalidateQueries({queryKey:["top-up-settings"]}),n({title:"Settings Saved",description:"Your auto top-up preferences have been updated."})},onError:s=>n({title:"Error",description:s.message,variant:"destructive"})}),{data:me}=H({queryKey:["plans"],queryFn:()=>o.getPlans()}),{data:he}=H({queryKey:["invoices"],queryFn:()=>o.getInvoices()}),x=parseFloat(b)||0,V=r?r.discount:0,K=Math.max(0,x-V),A=d==="cryptomus"||d==="manual",ee=A?0:K*Ie,T=K+ee,Q=x<m,pe=async()=>{if(N.trim()){if(x<m){n({title:"Error",description:`Please enter an amount of at least ${a(m)} first.`,variant:"destructive"});return}Z(!0);try{const s=await o.validateCoupon(N.toUpperCase(),x);s.valid&&(D({code:s.code,discount:s.discount,type:s.type,value:s.value}),n({title:"Coupon Applied",description:`You saved ${a(s.discount)}!`}))}catch(s){D(null),n({title:"Invalid Coupon",description:s.message||"This code is not valid.",variant:"destructive"})}finally{Z(!1)}}},xe=s=>{n({title:"Product Selected",description:`Switching to ${s}.`})},ye=async s=>{if(q(s),s&&t&&!t.has_payment_method)try{const{url:i}=await o.createSetupIntent();window.location.href=i}catch(i){n({title:"Setup Error",description:i.message,variant:"destructive"}),q(!1)}else S.mutate({enabled:s,threshold:parseFloat($),amount:parseFloat(w),max_monthly:parseFloat(L)})},je=()=>{S.mutate({enabled:F,threshold:parseFloat($),amount:parseFloat(w),max_monthly:parseFloat(L)})},fe=async()=>{if(Q){n({title:"Minimum not met",description:`Minimum purchase is ${a(m)}.`,variant:"destructive"});return}if(!d){n({title:"Select a payment method",description:"Please choose how you'd like to pay.",variant:"destructive"});return}if(d==="cryptomus"){p(!0);try{const{url:s}=await o.createCryptomusCheckout(x,r==null?void 0:r.code);window.location.href=s}catch(s){n({title:"Checkout Error",description:s.message,variant:"destructive"})}finally{p(!1)}}else if(d==="stripe"){p(!0);try{const{url:s}=await o.createCheckout(T,K,le.code);window.location.href=s}catch(s){n({title:"Checkout Error",description:s.message,variant:"destructive"})}finally{p(!1)}}else d==="manual"?J(!0):n({title:`Pay with ${d}`,description:`Redirecting to ${d} checkout for ${a(T)}...`})},se=[{id:"stripe",name:"Card (Stripe)",subtitle:"Credit/Debit Card",icon:te,vatLabel:"+22% VAT",enabled:j.stripe},{id:"paypal",name:"PayPal",subtitle:"PayPal Balance",icon:ve,vatLabel:"+22% VAT",enabled:j.paypal},{id:"cryptomus",name:"Crypto",subtitle:"Automated via Cryptomus",icon:R,vatLabel:"No VAT",enabled:j.cryptomus},{id:"manual",name:"Binance Pay",subtitle:"Manual Transfer",icon:R,vatLabel:"No VAT",enabled:j.crypto}],ge=se.length>0;return e.jsxs(e.Fragment,{children:[e.jsx(Ae,{title:"Account & Billing",noindex:!0}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Account & Billing"}),e.jsxs(P,{children:[e.jsxs(M,{children:[e.jsxs(k,{className:"flex items-center gap-2 text-lg",children:[e.jsx(be,{className:"h-5 w-5"})," ",y("billing.topUp")]}),e.jsxs(ie,{children:[y("billing.minPurchaseTitle"),": ",a(m),". 22% VAT applies to card & PayPal payments. Crypto is VAT-free."]})]}),e.jsxs(E,{className:"space-y-5",children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2 max-w-lg",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(v,{children:"Amount"}),e.jsx(f,{type:"number",value:b,onChange:s=>z(s.target.value),min:m,step:"1",placeholder:`Min ${a(m)}`}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:["10","25","50","100"].map(s=>e.jsx(u,{variant:"outline",size:"sm",className:`text-xs h-7 px-3 ${b===s?"border-primary bg-primary/5 text-primary":""}`,onClick:()=>z(s),children:a(Number(s))},s))}),Q&&x>0&&e.jsxs("p",{className:"text-xs text-destructive flex items-center gap-1",children:[e.jsx(ae,{className:"h-3 w-3"})," Minimum purchase is ",a(m)]})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(v,{children:"Promo Code (optional)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{placeholder:"WELCOME20",value:N,onChange:s=>W(s.target.value),className:r?"border-green-500 bg-green-500/5":"",disabled:!!r}),r?e.jsx(u,{variant:"outline",size:"sm",onClick:()=>{D(null),W("")},children:"Remove"}):e.jsx(u,{variant:"outline",size:"sm",className:"shrink-0",onClick:pe,disabled:X||!N.trim(),children:X?e.jsx(U,{className:"h-4 w-4 animate-spin"}):"Apply"})]}),r&&e.jsxs("p",{className:"text-[11px] text-green-600 font-medium",children:[" Coupon applied: ",r.type==="percentage"?`${r.value}%`:`${a(r.value)}`," off"]})]})]}),!ge&&e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"No payment methods are currently available. Please contact support."}),e.jsx("div",{className:"grid gap-3 sm:grid-cols-3",children:se.map(s=>{const i=s.enabled,c=d===s.id;return e.jsxs(u,{variant:c?"default":"outline",className:`h-auto py-4 flex-col gap-1 relative ${i?"":"opacity-40 cursor-not-allowed"}`,disabled:!i,onClick:()=>de(s.id),children:[e.jsx(s.icon,{className:"h-6 w-6"}),e.jsx("span",{className:"font-semibold",children:s.name}),e.jsx("span",{className:"text-[11px] font-normal opacity-80",children:s.subtitle}),e.jsx(g,{variant:s.id==="crypto"||s.id==="manual"?"default":"secondary",className:"text-[10px] mt-1",children:s.vatLabel}),!i&&e.jsx("span",{className:"text-[10px] font-normal",children:"Not available"})]},s.id)})}),d&&x>=m&&e.jsxs("div",{className:"rounded-lg border bg-muted/30 p-4 max-w-sm space-y-2",children:[e.jsx("h4",{className:"text-sm font-semibold",children:y("billing.orderSummary")}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:y("billing.subtotal")}),e.jsx("span",{children:a(x)})]}),V>0&&e.jsxs("div",{className:"flex justify-between text-sm text-green-600 font-medium font-mono",children:[e.jsxs("span",{children:["Discount (",r==null?void 0:r.code,")"]}),e.jsxs("span",{children:["-",a(V)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"flex items-center gap-1",children:["VAT (22%)",A&&e.jsx(we,{className:"h-3 w-3 text-muted-foreground"})]}),e.jsx("span",{className:A?"line-through text-muted-foreground":"",children:A?`${a(0)} â€” exempt`:`${a(ee)}`})]}),e.jsx(qe,{}),e.jsxs("div",{className:"flex justify-between text-sm font-bold",children:[e.jsx("span",{children:y("common.total")}),e.jsx("span",{children:a(T)})]}),e.jsxs(u,{className:"w-full mt-2",onClick:fe,disabled:Q||C,children:[C?e.jsx(U,{className:"mr-2 h-4 w-4 animate-spin"}):null,y("common.pay")," ",a(T)]})]})]})]}),oe&&e.jsxs(P,{className:t!=null&&t.global_enabled?"":"opacity-60 grayscale-[0.5]",children:[e.jsxs(M,{children:[e.jsxs(k,{className:"flex items-center justify-between text-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-5 w-5"})," Auto Top-Up"]}),t!=null&&t.has_payment_method?e.jsxs(g,{variant:"secondary",className:"bg-green-100 text-green-700 hover:bg-green-100 flex gap-1 items-center",children:[e.jsx(ne,{className:"h-3 w-3"})," Card Saved"]}):e.jsxs(g,{variant:"outline",className:"text-muted-foreground flex gap-1 items-center",children:[e.jsx(ae,{className:"h-3 w-3"})," No Card Saved"]})]}),!(t!=null&&t.global_enabled)&&e.jsx(ie,{className:"text-destructive font-medium",children:"Auto Top-up is currently disabled by the administrator."})]}),e.jsxs(E,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Enable Auto Top-Up"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Automatically add balance when it drops below the threshold"})]}),e.jsx($e,{checked:F,onCheckedChange:ye,disabled:!(t!=null&&t.global_enabled)})]}),F&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-3",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(v,{children:"Min Balance Threshold"}),e.jsx(f,{type:"number",value:$,onChange:s=>O(s.target.value)})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(v,{children:"Top-Up Amount"}),e.jsx(f,{type:"number",value:w,onChange:s=>Y(s.target.value)})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(v,{children:"Monthly Max Cap"}),e.jsx(f,{type:"number",value:L,onChange:s=>G(s.target.value)})]})]}),e.jsxs("div",{className:"flex justify-between items-center pt-2",children:[e.jsxs("p",{className:"text-[11px] text-muted-foreground max-w-[250px]",children:["A 22% Stripe VAT will be added to each auto top-up. Total charge: ",a(parseFloat(w)*1.22)]}),e.jsxs(u,{size:"sm",onClick:je,disabled:S.isPending,children:[S.isPending?e.jsx(U,{className:"h-3 w-3 animate-spin mr-1"}):e.jsx(Ce,{className:"h-3 w-3 mr-1"}),"Save Preferences"]})]})]})]})]}),e.jsx("div",{className:"grid gap-4 sm:grid-cols-3",children:(me||[]).map(s=>{const i=s.id===ce;return e.jsxs(P,{className:i?"border-primary ring-2 ring-primary/20":"",children:[e.jsx(M,{className:"pb-2",children:e.jsxs(k,{className:"flex items-center justify-between text-lg",children:[s.name,i&&e.jsx(g,{children:"Active"})]})}),e.jsxs(E,{className:"space-y-4",children:[e.jsxs("p",{className:"text-3xl font-bold",children:[a(s.price_cents/100),e.jsxs("span",{className:"text-base font-normal text-muted-foreground",children:["/",(s.id==="datacenter","GB")]})]}),e.jsx("ul",{className:"space-y-1.5",children:s.features.map(c=>e.jsxs("li",{className:"flex items-start gap-2 text-sm text-muted-foreground",children:[e.jsx(ne,{className:"mt-0.5 h-4 w-4 shrink-0 text-primary"}),c]},c))}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{variant:i?"outline":"default",className:"w-full",disabled:i,onClick:()=>xe(s.id),children:i?"Active Product":"Select Product"}),!i&&e.jsxs("div",{className:"flex flex-col gap-2",children:[j.stripe&&e.jsxs(u,{variant:"secondary",className:"w-full gap-2",disabled:C,onClick:async()=>{p(!0);try{const{url:c}=await o.createProductCheckout(s.id,1);window.location.href=c}catch(c){n({title:"Purchase Error",description:c.message,variant:"destructive"})}finally{p(!1)}},children:[e.jsx(te,{className:"h-4 w-4"})," Buy with Card"]}),j.cryptomus&&e.jsxs(u,{variant:"outline",className:"w-full gap-2 border-primary/20 hover:border-primary/50",disabled:C,onClick:async()=>{p(!0);try{const{url:c}=await o.createCryptomusProductCheckout(s.id,1);window.location.href=c}catch(c){n({title:"Purchase Error",description:c.message,variant:"destructive"})}finally{p(!1)}},children:[e.jsx(R,{className:"h-4 w-4 text-orange-500"})," Buy with Crypto"]})]})]})]})]},s.id)})}),e.jsxs(P,{children:[e.jsx(M,{children:e.jsx(k,{className:"text-lg",children:y("nav.invoices")})}),e.jsx(E,{className:"p-0",children:e.jsxs(Te,{children:[e.jsx(Pe,{children:e.jsxs(re,{children:[e.jsx(_,{children:"Period"}),e.jsx(_,{children:"Amount"}),e.jsx(_,{children:"Status"}),e.jsx(_,{className:"text-right",children:"Date"})]})}),e.jsx(Me,{children:(he||[]).map(s=>e.jsxs(re,{children:[e.jsx(B,{className:"font-medium",children:s.period}),e.jsx(B,{children:a(s.amount_cents/100)}),e.jsx(B,{children:e.jsx(g,{variant:Ve[s.status]??"secondary",children:s.status})}),e.jsxs(B,{className:"text-right text-sm text-muted-foreground space-x-2",children:[e.jsx("span",{children:new Date(s.created_at).toLocaleDateString()}),s.pdf_url&&e.jsx(u,{variant:"ghost",size:"icon",className:"h-7 w-7",asChild:!0,title:"Download PDF",children:e.jsx("a",{href:s.pdf_url,target:"_blank",rel:"noopener noreferrer",children:e.jsx(Se,{className:"h-3.5 w-3.5"})})})]})]},s.id))})]})})]})]}),e.jsx(De,{open:ue,onOpenChange:J,defaultAmount:b})]})}export{Ze as default};
