import{j as e,x as a}from"./ui-CeaNA1b8.js";import{r as i,ad as K,w as W,ab as X,ar as Z,aw as h,am as B,o as D}from"./vendor-CSZBJNtL.js";import{S as $}from"./SEOHead-CkgRsias.js";import{C as p,a as S,b as P,d as ee,c as u}from"./card-clxFFivi.js";import{a as se,B as R,I as k,t}from"./index-CiIhEAEh.js";import{L as A}from"./label-5YbheAOU.js";import{I as ae,a as te,b as n}from"./input-otp-g34q1mRh.js";import{k as re,l as ie,m as le,n as ne,o as ce}from"./use-backend-D0AC_UGJ.js";import"./useMutation-DksSUPdt.js";function ge(){const{user:j}=se(),[d,c]=i.useState("idle"),[o,f]=i.useState(""),[x,q]=i.useState(!1),[E,z]=i.useState([]),[g,F]=i.useState(""),[T,N]=i.useState(!1),{data:r,isLoading:H,refetch:M}=re(),v=ie(),w=le(),l=!!(j!=null&&j.is_2fa_enabled),{data:y}=ne(l),V=ce(),[m,_]=i.useState(""),[b,I]=i.useState(""),[L,O]=i.useState(!1),G=async()=>{if(!m||m!==b){t({title:"Validation Error",description:"Passwords do not match.",variant:"destructive"});return}O(!0);try{await V.mutateAsync({password:m,password_confirmation:b}),t({title:"Password updated successfully"}),_(""),I("")}catch(s){t({title:"Error",description:s.message,variant:"destructive"})}finally{O(!1)}},U=()=>{M(),c("setup")},Q=async()=>{if(o.length!==6){t({title:"Invalid code",description:"Enter a 6-digit code",variant:"destructive"});return}try{const s=await v.mutateAsync(o);z(s.recovery_codes),c("idle"),f(""),t({title:"2FA Enabled",description:"Your account is now protected."})}catch(s){t({title:"Verification failed",description:s.message,variant:"destructive"})}},Y=async()=>{if(!g){t({title:"Password required",description:"Please enter your password to disable 2FA.",variant:"destructive"});return}try{await w.mutateAsync({password:g}),t({title:"2FA Disabled",description:"Two-factor authentication has been turned off."}),F(""),N(!1)}catch(s){t({title:"Error",description:s.message,variant:"destructive"})}},C=E.length>0?E:(y==null?void 0:y.recovery_codes)||[];return e.jsxs(e.Fragment,{children:[e.jsx($,{title:"Security & 2FA",noindex:!0}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Security & 2FA"}),e.jsxs(p,{children:[e.jsx(S,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[l?e.jsx(K,{className:"h-8 w-8 text-success"}):e.jsx(W,{className:"h-8 w-8 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx(P,{className:"text-lg",children:"Two-Factor Authentication (TOTP)"}),e.jsx(ee,{children:"Add an extra layer of security using an authenticator app like Google Authenticator or Authy."})]}),e.jsx(R,{variant:l?"default":"secondary",className:"ml-auto",children:l?"Enabled":"Disabled"})]})}),e.jsxs(u,{className:"space-y-4",children:[l&&d==="idle"&&e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx("p",{className:"text-sm text-green-600 font-medium",children:"Two-factor authentication is active on your account."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(a,{variant:"outline",size:"sm",onClick:()=>q(!x),children:[x?e.jsx(X,{className:"mr-1 h-4 w-4"}):e.jsx(Z,{className:"mr-1 h-4 w-4"}),x?"Hide":"Show"," Backup Codes"]}),!T&&e.jsx(a,{variant:"destructive",size:"sm",onClick:()=>N(!0),children:"Disable 2FA"})]}),T&&e.jsxs("div",{className:"flex flex-col gap-3 max-w-sm rounded-lg border bg-muted/50 p-4",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(A,{htmlFor:"disable-pass",children:"Confirm Password to Disable"}),e.jsx(k,{id:"disable-pass",type:"password",placeholder:"Your password",value:g,onChange:s=>F(s.target.value)})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(a,{variant:"destructive",onClick:Y,disabled:w.isPending,className:"flex-1",children:[w.isPending?e.jsx(h,{className:"mr-2 h-4 w-4 animate-spin"}):null,"Confirm Disable"]}),e.jsx(a,{variant:"ghost",onClick:()=>N(!1),className:"flex-1",children:"Cancel"})]})]}),x&&C.length>0&&e.jsx(p,{className:"bg-muted",children:e.jsxs(u,{className:"py-3",children:[e.jsx("p",{className:"text-xs font-medium mb-2",children:"Save these backup codes in a safe place:"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:C.map((s,J)=>e.jsx("code",{className:"text-xs font-mono bg-background px-2 py-1.5 rounded border",children:s},J))}),e.jsxs(a,{variant:"ghost",size:"sm",className:"mt-3 w-full",onClick:()=>{navigator.clipboard.writeText(C.join(`
`)),t({title:"Copied to clipboard"})},children:[e.jsx(B,{className:"mr-2 h-3 w-3"})," Copy All Codes"]})]})})]}),!l&&d==="idle"&&e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Protect your account by requiring a security code whenever you sign in."}),e.jsxs(a,{onClick:U,className:"w-fit",children:[e.jsx(D,{className:"mr-2 h-4 w-4"})," Enable 2FA"]})]}),d==="setup"&&e.jsx("div",{className:"space-y-6",children:H?e.jsxs("div",{className:"flex items-center justify-center py-10",children:[e.jsx(h,{className:"h-10 w-10 animate-spin text-primary"}),e.jsx("span",{className:"ml-3 text-muted-foreground",children:"Generating secure keys..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold",children:"Step 1: Scan QR Code"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Open your authenticator app and scan the code below:"})]}),e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("div",{className:"rounded-xl border bg-white p-4 shadow-sm",children:r!=null&&r.qr_code_svg?e.jsx("div",{dangerouslySetInnerHTML:{__html:r.qr_code_svg},className:"w-[200px] h-[200px]"}):e.jsx("div",{className:"w-[200px] h-[200px] flex items-center justify-center text-red-500",children:"Error generating QR code"})})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold",children:"Alternative: Manual Entry"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"If you can't scan, enter this secret key manually:"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("code",{className:"flex-1 bg-muted px-4 py-2 rounded-lg text-sm font-mono border tracking-wider",children:r==null?void 0:r.secret}),e.jsx(a,{variant:"outline",size:"icon",onClick:()=>{r&&(navigator.clipboard.writeText(r.secret),t({title:"Secret copied"}))},children:e.jsx(B,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t",children:[e.jsx(a,{variant:"ghost",onClick:()=>c("idle"),className:"flex-1",children:"Cancel"}),e.jsx(a,{onClick:()=>c("verify"),disabled:!r,className:"flex-1",children:"Next Step"})]})]})}),d==="verify"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold",children:"Step 2: Verify Setup"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Enter the 6-digit code from your app to confirm."})]}),e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(ae,{maxLength:6,value:o,onChange:f,children:e.jsxs(te,{className:"gap-2",children:[e.jsx(n,{index:0,className:"w-12 h-14 text-xl border-2"}),e.jsx(n,{index:1,className:"w-12 h-14 text-xl border-2"}),e.jsx(n,{index:2,className:"w-12 h-14 text-xl border-2"}),e.jsx(n,{index:3,className:"w-12 h-14 text-xl border-2"}),e.jsx(n,{index:4,className:"w-12 h-14 text-xl border-2"}),e.jsx(n,{index:5,className:"w-12 h-14 text-xl border-2"})]})})}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t",children:[e.jsx(a,{variant:"outline",onClick:()=>{c("setup"),f("")},className:"flex-1",children:"Back"}),e.jsxs(a,{onClick:Q,disabled:o.length!==6||v.isPending,className:"flex-1",children:[v.isPending?e.jsx(h,{className:"mr-2 h-4 w-4 animate-spin"}):null,"Confirm & Enable"]})]})]})]})]}),e.jsxs(p,{children:[e.jsx(S,{children:e.jsx(P,{className:"text-lg",children:"Change Password"})}),e.jsxs(u,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2 max-w-sm",children:[e.jsx(A,{children:"New Password"}),e.jsx(k,{type:"password",placeholder:"••••••••",value:m,onChange:s=>_(s.target.value)})]}),e.jsxs("div",{className:"space-y-2 max-w-sm",children:[e.jsx(A,{children:"Confirm New Password"}),e.jsx(k,{type:"password",placeholder:"••••••••",value:b,onChange:s=>I(s.target.value)})]}),e.jsxs(a,{onClick:G,disabled:L,children:[L?e.jsx(h,{className:"mr-2 h-4 w-4 animate-spin"}):null,"Update Password"]})]})]}),e.jsxs(p,{children:[e.jsx(S,{children:e.jsx(P,{className:"text-lg",children:"Active Sessions"})}),e.jsx(u,{children:e.jsxs("div",{className:"flex items-center justify-between rounded-lg border p-4 bg-muted/20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-background rounded-full border shadow-sm",children:e.jsx(D,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Current Session"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:navigator.userAgent.split(" ").pop()})]})]}),e.jsx(R,{variant:"default",className:"bg-green-100 text-green-700 hover:bg-green-100",children:"Live now"})]})})]})]})]})}export{ge as default};
